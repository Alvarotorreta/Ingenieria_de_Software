<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misi√≥n Emprende - Presentaci√≥n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .stage-info {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stage-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .stage-title {
            color: #667eea;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stage-description {
            color: #666;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .activity-info {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .activity-title {
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .progress-stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
        }

        .stat {
            padding: 15px 25px;
            background: white;
            border-radius: 10px;
            text-align: center;
            min-width: 150px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .teams-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .teams-section h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .team-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
            transition: all 0.3s;
        }

        .team-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .team-name-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .team-color {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            color: white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .team-info h3 {
            color: #333;
            font-size: 20px;
            margin-bottom: 5px;
        }

        .team-info p {
            color: #666;
            font-size: 14px;
        }

        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.in-progress {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.completed {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.pending {
            background: #f8d7da;
            color: #721c24;
        }

        .personalization-details {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .personalization-details h4 {
            color: #333;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .detail-item {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detail-label {
            color: #666;
            font-size: 14px;
            font-weight: 600;
            min-width: 120px;
        }

        .detail-value {
            color: #333;
            font-size: 14px;
        }

        .know-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .know-badge.yes {
            background: #d4edda;
            color: #155724;
        }

        .know-badge.no {
            background: #f8d7da;
            color: #721c24;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üéÆ Presentaci√≥n</h1>
                <p id="roomCodeDisplay">Sala: <strong id="roomCode">---</strong></p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-danger" onclick="finalizeSession()">
                    üèÅ Finalizar Sala
                </button>
                <button class="btn" onclick="window.location.href='/panel/'">
                    ‚Üê Volver al Panel
                </button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- Informaci√≥n de Etapa -->
        <div class="stage-info">
            <div class="stage-icon" id="stageIcon">üë•</div>
            <h2 class="stage-title" id="stageTitle">Etapa 1: Trabajo en Equipo</h2>
            <p class="stage-description" id="stageDescription">
                Los equipos est√°n jugando el minijuego de anagramas: adivina las palabras desordenadas
            </p>
            
            <div class="activity-info">
                <div class="activity-title">Actividad Actual: Presentaci√≥n</div>
                <!-- Temporizador -->
                <div id="timerContainerProf" style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center; border: 2px solid #ffc107;">
                    <p style="margin: 0; color: #856404; font-weight: 600; font-size: 16px;">
                        ‚è±Ô∏è Tiempo restante: <span id="timerDisplayProf">--:--</span>
                    </p>
                </div>
                <div class="progress-stats">
                    <div class="stat">
                        <div class="stat-value" id="completedTeams">0</div>
                        <div class="stat-label">Completados</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="inProgressTeams">0</div>
                        <div class="stat-label">En Progreso</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="totalTeams">0</div>
                        <div class="stat-label">Total Equipos</div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" id="nextActivityBtn" onclick="nextActivity()" style="display: none;">
                    Continuar a Siguiente Actividad
                </button>
            </div>
        </div>

        <!-- Equipos -->
        <div class="teams-section">
            <h2>üë• Estado de Equipos</h2>
            <div class="teams-grid" id="teamsGrid">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Cargando equipos...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api';
        let authToken = localStorage.getItem('authToken');
        let currentSessionId = null;

        // Obtener session_id de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const pathParts = window.location.pathname.split('/').filter(p => p);
        
        // Buscar en diferentes patrones de URL
        const presentacionIndex = pathParts.indexOf('presentacion');
        const personalizacionIndex = pathParts.indexOf('personalizacion');
        const gameControlIndex = pathParts.indexOf('game-control');
        
        if (presentacionIndex !== -1 && pathParts[presentacionIndex + 1]) {
            currentSessionId = parseInt(pathParts[presentacionIndex + 1]);
        } else if (personalizacionIndex !== -1 && pathParts[personalizacionIndex + 1]) {
            currentSessionId = parseInt(pathParts[personalizacionIndex + 1]);
        } else if (gameControlIndex !== -1 && pathParts[gameControlIndex + 1]) {
            currentSessionId = parseInt(pathParts[gameControlIndex + 1]);
        } else {
            currentSessionId = urlParams.get('session_id') ? parseInt(urlParams.get('session_id')) : null;
        }
        
        console.log('üîç Current Session ID:', currentSessionId, 'from path:', window.location.pathname); // Debug
        console.log('üîç URL completa:', window.location.href); // Debug
        
        if (!authToken) {
            console.error('‚ùå No hay token de autenticaci√≥n, redirigiendo a login');
            window.location.href = '/login/';
        } else {
            console.log('‚úÖ Token de autenticaci√≥n presente'); // Debug

            if (!currentSessionId || isNaN(currentSessionId)) {
                console.error('Session ID no v√°lido:', currentSessionId); // Debug
                // Mostrar alerta antes de redirigir
                setTimeout(() => {
                    window.location.href = '/panel/';
                }, 2000);
            } else {
                // C√≥digo principal solo se ejecuta si hay token y sessionId v√°lido
                initializePage();
            }
        }

        // Variables globales para temporizador (declaradas antes de cualquier uso)
        let timerIntervalProf = null;
        let timerStartTimeProf = null;
        let timerDurationProf = null;
        
        // Intentar restaurar timerStartTimeProf desde sessionStorage (solo si ya existe)
        // Pero siempre verificar con el servidor para sincronizaci√≥n correcta
        const storedTimerStartProf = sessionStorage.getItem(`timerStartTimeProf_${currentSessionId}`);
        if (storedTimerStartProf) {
            const storedTime = parseInt(storedTimerStartProf);
            // Solo usar si es v√°lido y no es muy antiguo (m√°s de 1 hora)
            const oneHourAgo = Date.now() - (60 * 60 * 1000);
            if (storedTime > oneHourAgo) {
                timerStartTimeProf = storedTime;
            }
        }

        function initializePage() {
            // Cargar estado inicial
            console.log('üîÑ Iniciando carga de datos de personalizaci√≥n...'); // Debug
            const loadingEl = document.getElementById('loading');
            if (loadingEl) {
                loadingEl.classList.add('show');
            } else {
                console.warn('‚ö†Ô∏è Elemento loading no encontrado en el DOM');
            }
            
            // Cargar datos inmediatamente
            loadGameControl();

            // Polling cada 2 segundos para actualizar estado en tiempo real
            const pollInterval = setInterval(() => {
                console.log('üîÑ Polling: Actualizando estado del juego...');
                loadGameControl();
            }, 2000);
            
            // Tambi√©n actualizar inmediatamente despu√©s de un peque√±o delay para asegurar que se cargue
            setTimeout(() => {
                console.log('üîÑ Carga inicial con delay...');
                loadGameControl();
            }, 500);

            // Limpiar intervalo cuando se cierra la p√°gina
            window.addEventListener('beforeunload', () => {
                if (pollInterval) {
                    clearInterval(pollInterval);
                }
            });
        }

        function showAlert(message, type = 'error') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        function getTeamColorHex(color) {
            const colorMap = {
                'Verde': '#28a745',
                'Azul': '#007bff',
                'Rojo': '#dc3545',
                'Amarillo': '#ffc107',
                'Naranja': '#fd7e14',
                'Morado': '#6f42c1',
                'Rosa': '#e83e8c',
                'Cian': '#17a2b8',
                'Gris': '#6c757d',
                'Marr√≥n': '#795548'
            };
            return colorMap[color] || '#667eea';
        }

        async function loadGameControl() {
            try {
                if (!currentSessionId || isNaN(currentSessionId)) {
                    console.error('Error: currentSessionId no es v√°lido:', currentSessionId);
                    showAlert('Error: ID de sesi√≥n no v√°lido', 'error');
                    return;
                }

                console.log('Cargando sesi√≥n ID:', currentSessionId); // Debug
                
                // Obtener informaci√≥n de la sesi√≥n
                console.log('üîç Haciendo petici√≥n a:', `${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/`);
                console.log('üîë Token de autenticaci√≥n:', authToken ? 'Presente' : 'Ausente');
                
                const sessionResponse = await fetch(`${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì° Respuesta de sesi√≥n:', sessionResponse.status, sessionResponse.statusText);

                if (!sessionResponse.ok) {
                    const errorData = await sessionResponse.json().catch(() => {
                        return { error: 'Error desconocido', detail: sessionResponse.statusText };
                    });
                    console.error('‚ùå Error al cargar sesi√≥n:', sessionResponse.status, errorData);
                    showAlert(`Error al cargar la sesi√≥n (${sessionResponse.status}): ${errorData.error || errorData.detail || 'Error desconocido'}`, 'error');
                    return;
                }

                const sessionData = await sessionResponse.json();
                console.log('‚úÖ Session Data recibida:', sessionData); // Debug
                console.log('   - room_code:', sessionData.room_code);
                console.log('   - status:', sessionData.status);
                console.log('   - current_stage_name:', sessionData.current_stage_name);
                console.log('   - current_activity_name:', sessionData.current_activity_name);
                
                // Iniciar temporizador si hay actividad y no est√° iniciado
                // Guardar datos de sesi√≥n para sincronizaci√≥n
                sessionStorage.setItem('lastSessionData', JSON.stringify({
                    current_activity: sessionData.current_activity,
                    started_at: sessionData.started_at
                }));
                
                if (sessionData.current_activity && !timerIntervalProf) {
                    startTimerProf(sessionData.current_activity, sessionData.started_at);
                }
                
                // Actualizar c√≥digo de sala
                const roomCodeEl = document.getElementById('roomCode');
                if (roomCodeEl) {
                    if (sessionData.room_code) {
                        roomCodeEl.textContent = sessionData.room_code;
                        console.log('‚úÖ C√≥digo de sala actualizado:', sessionData.room_code); // Debug
                    } else {
                        console.warn('‚ö†Ô∏è room_code no est√° disponible en sessionData:', sessionData);
                        roomCodeEl.textContent = '---';
                    }
                } else {
                    console.error('‚ùå Elemento roomCode no encontrado en el DOM');
                }
                
                // Actualizar informaci√≥n de etapa y actividad
                if (sessionData.current_stage_name) {
                    const stageNumber = sessionData.current_stage_number || '?';
                    document.getElementById('stageTitle').textContent = `Etapa ${stageNumber}: ${sessionData.current_stage_name}`;
                } else {
                    document.getElementById('stageTitle').textContent = 'Etapa: No iniciada';
                }
                
                if (sessionData.current_activity_name) {
                    document.getElementById('stageDescription').textContent = `Actividad Actual: ${sessionData.current_activity_name}`;
                } else {
                    document.getElementById('stageDescription').textContent = 'Actividad: No iniciada';
                }

                // Obtener equipos con personalizaci√≥n
                console.log('üîç Obteniendo equipos para sesi√≥n:', currentSessionId);
                const teamsResponse = await fetch(`${API_BASE_URL}/sessions/teams/?game_session=${currentSessionId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì° Respuesta de equipos:', teamsResponse.status, teamsResponse.statusText);

                if (!teamsResponse.ok) {
                    const errorData = await teamsResponse.json().catch(() => ({}));
                    console.error('‚ùå Error al cargar equipos:', teamsResponse.status, errorData);
                    showAlert(`Error al cargar los equipos (${teamsResponse.status}): ${errorData.error || errorData.detail || ''}`, 'error');
                    return;
                }

                const teamsData = await teamsResponse.json();
                console.log('‚úÖ Teams Data recibida:', teamsData); // Debug
                const teams = teamsData.results || teamsData;
                console.log('üìä Equipos encontrados:', teams.length, teams); // Debug
                
                if (teams.length === 0) {
                    console.warn('‚ö†Ô∏è No se encontraron equipos para esta sesi√≥n');
                }

                // Obtener personalizaciones y progreso de la actividad de Presentaci√≥n para todos los equipos
                const activityProgress = {};
                const teamPersonalizations = {};
                console.log('üîç Obteniendo progreso de actividad para', teams.length, 'equipos');
                
                // Primero obtener la actividad actual
                const currentActivityId = sessionData.current_activity;
                if (!currentActivityId) {
                    console.error('‚ùå No hay actividad actual en la sesi√≥n');
                    showAlert('Error: No hay actividad actual', 'error');
                    return;
                }
                
                // Obtener session_stage
                const sessionStagesResponse = await fetch(`${API_BASE_URL}/sessions/session-stages/?game_session=${currentSessionId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                let sessionStageId = null;
                if (sessionStagesResponse.ok) {
                    const stagesData = await sessionStagesResponse.json();
                    const stages = stagesData.results || stagesData;
                    if (stages.length > 0) {
                        sessionStageId = stages[0].id;
                    }
                }
                
                for (const team of teams) {
                    try {
                        // Obtener personalizaci√≥n del equipo
                        const persResponse = await fetch(`${API_BASE_URL}/sessions/team-personalizations/?team=${team.id}`, {
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (persResponse.ok) {
                            const persData = await persResponse.json();
                            const persResults = persData.results || persData;
                            if (persResults.length > 0) {
                                teamPersonalizations[team.id] = persResults[0];
                            }
                        }
                        
                        console.log(`  üìã Obteniendo progreso para equipo ${team.id} (${team.name || 'Sin nombre'})`);
                        let progressUrl = `${API_BASE_URL}/sessions/team-activity-progress/?team=${team.id}&activity=${currentActivityId}`;
                        if (sessionStageId) {
                            progressUrl += `&session_stage=${sessionStageId}`;
                        }
                        
                        const progressResponse = await fetch(progressUrl, {
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        console.log(`    üì° Respuesta: ${progressResponse.status} ${progressResponse.statusText}`);
                        
                        if (progressResponse.ok) {
                            const progressData = await progressResponse.json();
                            const progressResults = progressData.results || progressData;
                            console.log(`    üìä Progreso encontrado: ${progressResults.length}`, progressResults);
                            if (progressResults.length > 0) {
                                const progressObj = progressResults[0];
                                activityProgress[team.id] = progressObj;
                                console.log(`    ‚úÖ Progreso guardado para equipo ${team.id}:`, {
                                    id: progressObj.id,
                                    status: progressObj.status,
                                    response_data: progressObj.response_data,
                                    progress_percentage: progressObj.progress_percentage,
                                    started_at: progressObj.started_at,
                                    completed_at: progressObj.completed_at
                                });
                                // Log espec√≠fico para equipos completados
                                if (progressObj.status === 'completed') {
                                    console.log(`    üéâ EQUIPO ${team.id} COMPLETADO! Status: ${progressObj.status}, Completed_at: ${progressObj.completed_at}`);
                                }
                            } else {
                                console.log(`    ‚ö†Ô∏è No hay progreso para equipo ${team.id}`);
                            }
                        } else {
                            const errorData = await progressResponse.json().catch(() => ({}));
                            console.warn(`    ‚ö†Ô∏è Error al obtener progreso para equipo ${team.id}:`, progressResponse.status, errorData);
                        }
                    } catch (error) {
                        console.error(`    ‚ùå Error loading progress for team ${team.id}:`, error);
                    }
                }
                
                console.log('üìù Total progreso obtenido:', Object.keys(activityProgress).length);
                // Log detallado del progreso para debug
                for (const [teamId, prog] of Object.entries(activityProgress)) {
                    console.log(`üìù Equipo ${teamId} progreso completo:`, {
                        id: prog.id,
                        status: prog.status,
                        response_data: prog.response_data,
                        progress_percentage: prog.progress_percentage,
                        started_at: prog.started_at,
                        completed_at: prog.completed_at
                    });
                    // Log espec√≠fico para equipos completados
                    if (prog.status === 'completed') {
                        console.log(`üéâ EQUIPO ${teamId} EST√Å COMPLETADO! Status: ${prog.status}, Completed_at: ${prog.completed_at}`);
                    }
                }

                // Renderizar equipos
                console.log('Progreso encontrado:', Object.keys(activityProgress).length); // Debug
                console.log('Total equipos a renderizar:', teams.length); // Debug
                renderTeams(teams, activityProgress, teamPersonalizations);

                // Ocultar loading
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.classList.remove('show');
                }
            } catch (error) {
                console.error('Error loading game control:', error);
                showAlert('Error de conexi√≥n: ' + error.message, 'error');
            }
        }

        function renderTeams(teams, activityProgress, teamPersonalizations) {
            const teamsGrid = document.getElementById('teamsGrid');
            
            // Limpiar loading si existe
            const loadingElement = teamsGrid.querySelector('.loading');
            if (loadingElement) {
                loadingElement.remove();
            }
            
            let completedCount = 0;
            let inProgressCount = 0;

            if (teams.length === 0) {
                teamsGrid.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No hay equipos en esta sesi√≥n.</p>';
                return;
            }

            teamsGrid.innerHTML = teams.map(team => {
                const progress = activityProgress[team.id] || null;
                const personalization = teamPersonalizations[team.id] || null;
                const teamKnowsEachOther = personalization?.team_members_know_each_other;
                
                // Debug detallado para cada equipo
                console.log(`üîç Renderizando equipo ${team.id} (${team.name}):`, {
                    hasProgress: !!progress,
                    progressStatus: progress?.status,
                    hasResponseData: !!progress?.response_data,
                    responseData: progress?.response_data,
                    knowsEachOther: teamKnowsEachOther,
                    progressPercentage: progress?.progress_percentage
                });
                
                const isCompleted = progress && progress.status === 'completed';
                
                // Determinar tipo de actividad seg√∫n si se conocen
                let activityType = 'unknown';
                let activityDetails = '';
                
                if (teamKnowsEachOther === true) {
                    // Equipo que se conoce ‚Üí minijuego de anagramas
                    activityType = 'anagram';
                    if (progress) {
                        // Siempre mostrar informaci√≥n si hay progreso (aunque est√© vac√≠o)
                        const responseData = progress.response_data || {};
                        const correctAnswers = responseData.correct_answers || 0;
                        const totalWords = responseData.total_words || 3;
                        const tokensEarned = responseData.tokens_earned || 0;
                        const progressPercentage = progress.progress_percentage || 0;
                        
                        console.log(`üìä Equipo ${team.id} - Anagrama:`, {
                            correctAnswers,
                            totalWords,
                            tokensEarned,
                            progressPercentage,
                            status: progress.status,
                            responseData: responseData
                        });
                        
                        activityDetails = `
                            <div class="detail-item">
                                <span class="detail-label">Palabras correctas:</span>
                                <span class="detail-value"><strong>${correctAnswers}/${totalWords}</strong></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Tokens ganados:</span>
                                <span class="detail-value"><strong style="color: #28a745;">${tokensEarned} tokens</strong></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Progreso:</span>
                                <span class="detail-value"><strong>${progressPercentage}%</strong></span>
                            </div>
                        `;
                    } else {
                        activityDetails = `
                            <div class="detail-item">
                                <span class="detail-value" style="color: #999;">A√∫n no ha iniciado el minijuego</span>
                            </div>
                        `;
                    }
                } else if (teamKnowsEachOther === false) {
                    // Equipo que NO se conoce ‚Üí actividad de presentaci√≥n (hablar)
                    activityType = 'presentation';
                    const isPresCompleted = progress && progress.status === 'completed';
                    activityDetails = `
                        <div class="detail-item">
                            <span class="detail-value">
                                ${isPresCompleted ? 
                                    '<span style="color: #28a745;">‚úÖ Presentaci√≥n completada</span>' : 
                                    '<span style="color: #666;">En proceso de presentaci√≥n</span>'}
                            </span>
                        </div>
                    `;
                } else {
                    // A√∫n no se ha definido
                    activityType = 'pending';
                    activityDetails = `
                        <div class="detail-item">
                            <span class="detail-value" style="color: #999;">A√∫n no ha iniciado la actividad</span>
                        </div>
                    `;
                }
                
                if (isCompleted) {
                    completedCount++;
                } else {
                    // En Progreso: todos los que no est√°n completados
                    inProgressCount++;
                }

                // Determinar el estado correcto
                let status = 'pending';
                let statusText = 'Pendiente';
                
                if (progress) {
                    if (progress.status === 'completed') {
                        status = 'completed';
                        statusText = 'Listo';
                    } else if (progress.status === 'in_progress') {
                        status = 'in-progress';
                        statusText = 'En Progreso';
                    } else if (progress.status === 'submitted') {
                        status = 'in-progress';
                        statusText = 'Entregado';
                    } else {
                        status = 'pending';
                        statusText = 'Pendiente';
                    }
                }

                return `
                    <div class="team-card" style="border-left-color: ${getTeamColorHex(team.color)};">
                        <div class="team-header">
                            <div class="team-name-section">
                                <div class="team-color" style="background: ${getTeamColorHex(team.color)};">
                                    ${team.color.charAt(0).toUpperCase()}
                                </div>
                                <div class="team-info">
                                    <h3>${team.name}</h3>
                                    <p>${team.students_count} estudiantes</p>
                                </div>
                            </div>
                            <div class="status-badge ${status}">
                                ${statusText}
                            </div>
                        </div>

                        <div class="personalization-details">
                            <h4>${activityType === 'anagram' ? 'üéÆ Minijuego - Anagramas' : activityType === 'presentation' ? 'üëã Presentaci√≥n - Hablar' : '‚è≥ Esperando'}</h4>
                            ${activityDetails}
                        </div>
                    </div>
                `;
            }).join('');

            // Actualizar estad√≠sticas
            document.getElementById('completedTeams').textContent = completedCount;
            document.getElementById('inProgressTeams').textContent = inProgressCount;
            document.getElementById('totalTeams').textContent = teams.length;

            // Mostrar bot√≥n de continuar si todos est√°n completos
            const nextBtn = document.getElementById('nextActivityBtn');
            if (completedCount === teams.length && teams.length > 0) {
                nextBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'none';
            }
        }

        async function startTimerProf(activityId, sessionStartedAt) {
            try {
                // Intentar restaurar desde sessionStorage primero
                const storedTimerStart = sessionStorage.getItem(`timerStartTimeProf_${currentSessionId}_${activityId}`);
                const storedTimerDuration = sessionStorage.getItem(`timerDurationProf_${currentSessionId}_${activityId}`);
                
                if (storedTimerStart && storedTimerDuration) {
                    const storedDuration = parseInt(storedTimerDuration);
                    // Solo restaurar si la duraci√≥n es v√°lida
                    if (storedDuration && storedDuration > 0) {
                        timerStartTimeProf = parseInt(storedTimerStart);
                        timerDurationProf = storedDuration;
                        console.log('‚úÖ Temporizador restaurado desde sessionStorage:', {
                            startTime: new Date(timerStartTimeProf).toISOString(),
                            duration: timerDurationProf
                        });
                    } else {
                        // Si la duraci√≥n almacenada no es v√°lida, limpiar y obtener del servidor
                        sessionStorage.removeItem(`timerStartTimeProf_${currentSessionId}_${activityId}`);
                        sessionStorage.removeItem(`timerDurationProf_${currentSessionId}_${activityId}`);
                    }
                }
                
                // Si no se restaur√≥ desde sessionStorage o no era v√°lido, obtener del servidor
                if (!timerStartTimeProf || !timerDurationProf) {
                    // Obtener informaci√≥n del temporizador desde el endpoint centralizado
                    const timerResponse = await fetch(`${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/activity_timer/`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!timerResponse.ok) {
                        throw new Error('Error al obtener informaci√≥n del temporizador');
                    }
                    
                    const timerData = await timerResponse.json();
                    
                    if (timerData.error) {
                        throw new Error(timerData.error);
                    }
                    
                    timerDurationProf = timerData.timer_duration; // En segundos (desde el modelo, puede ser null)
                    
                    // Validar que timer_duration est√© configurado
                    if (timerDurationProf === null || timerDurationProf === undefined) {
                        console.warn('‚ö†Ô∏è La actividad no tiene timer_duration configurado. No se puede iniciar el temporizador.');
                        showAlert('La actividad no tiene tiempo configurado. Por favor, config√∫relo en el admin de Django.', 'error');
                        return;
                    }
                    
                    if (timerData.started_at) {
                        timerStartTimeProf = new Date(timerData.started_at).getTime();
                    } else {
                        // Si no hay started_at, usar el tiempo actual del servidor
                        timerStartTimeProf = new Date(timerData.current_time).getTime();
                    }
                    
                    // Guardar en sessionStorage para persistir entre recargas (solo si timerDurationProf es v√°lido)
                    if (timerDurationProf !== null && timerDurationProf !== undefined) {
                        sessionStorage.setItem(`timerStartTimeProf_${currentSessionId}_${activityId}`, timerStartTimeProf.toString());
                        sessionStorage.setItem(`timerDurationProf_${currentSessionId}_${activityId}`, timerDurationProf.toString());
                    }
                    
                    console.log('‚úÖ Temporizador inicializado desde servidor:', {
                        activityId: activityId,
                        duration: timerDurationProf,
                        startedAt: timerData.started_at
                    });
                }
                
                // Continuar con la l√≥gica del temporizador (solo si timerDurationProf es v√°lido)
                if (!timerDurationProf || timerDurationProf <= 0) {
                    console.warn('‚ö†Ô∏è No se puede iniciar el temporizador: timerDurationProf no es v√°lido');
                    return;
                }
                
                const timerDisplay = document.getElementById('timerDisplayProf');
                if (timerDisplay) {
                    const updateTimer = () => {
                        if (!timerStartTimeProf || !timerDurationProf) {
                            return; // No actualizar si faltan datos
                        }
                        const elapsed = Math.floor((Date.now() - timerStartTimeProf) / 1000);
                        const remaining = Math.max(0, timerDurationProf - elapsed);
                        
                        const minutes = Math.floor(remaining / 60);
                        const seconds = remaining % 60;
                        timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                        
                        if (remaining <= 0) {
                            clearInterval(timerIntervalProf);
                            timerIntervalProf = null;
                            timerDisplay.textContent = '00:00';
                        }
                    };
                    
                    updateTimer();
                    if (!timerIntervalProf) {
                        timerIntervalProf = setInterval(updateTimer, 1000);
                    }
                }
            } catch (error) {
                console.error('Error starting timer:', error);
                showAlert('Error al iniciar temporizador: ' + error.message, 'error');
            }
        }

        async function nextActivity() {
            if (!confirm('¬øAvanzar a la siguiente actividad? Todos los equipos deben haber completado la actividad actual.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/next_activity/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Si se complet√≥ la etapa, redirigir a resultados
                    if (data.stage_completed) {
                        showAlert(`¬°${data.message}`, 'success');
                        setTimeout(() => {
                            window.location.replace(`/profesor/resultados/${currentSessionId}/?stage_id=${data.stage_id}`);
                        }, 1500);
                    } else {
                        const nextActivityName = data.current_activity_name;
                        showAlert(`Actividad actualizada a: ${nextActivityName}`, 'success');
                        // Recargar datos
                        loadGameControl();
                    }
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.error || 'Error al avanzar a la siguiente actividad', 'error');
                }
            } catch (error) {
                showAlert('Error de conexi√≥n: ' + error.message, 'error');
            }
        }

        async function finalizeSession() {
            if (!confirm('¬øEst√°s seguro de que deseas finalizar esta sesi√≥n? Se desconectar√°n todas las tablets y no podr√°s acceder al lobby nuevamente.')) {
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n no se puede deshacer. ¬øContinuar?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/end/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showAlert(`¬°Sesi√≥n finalizada exitosamente! Se desconectaron ${data.tablets_disconnected || 0} tablets.`, 'success');
                    // Redirigir al panel despu√©s de 2 segundos
                    setTimeout(() => {
                        window.location.href = '/panel/';
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.error || 'Error al finalizar la sesi√≥n');
                }
            } catch (error) {
                showAlert('Error de conexi√≥n: ' + error.message);
            }
        }

    </script>
</body>
</html>

