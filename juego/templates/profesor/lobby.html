<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misi√≥n Emprende - Lobby de Sala</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1000px;
            width: 100%;
        }

        .panel-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .panel-header h2 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .panel-content {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .team-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .team-card.drag-over {
            background: #f0f4ff;
            border: 2px dashed #667eea;
            transform: scale(1.01);
        }

        .team-card.drag-over > div > div[id^="students-container"] {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            padding: 10px;
            min-height: 60px;
            transition: all 0.3s;
        }

        .student-dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        [draggable="true"]:hover {
            background: #e9ecef !important;
            border-color: #667eea !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel-header">
            <h2>üéÆ Lobby de Sala: <span id="roomCode">Cargando...</span></h2>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="btn" onclick="finalizeSession()" style="background: #dc3545; max-width: 200px;">
                    üèÅ Finalizar Sala
                </button>
                <button class="btn" onclick="window.location.href='/panel/'" style="background: #6c757d; max-width: 200px;">
                    ‚Üê Volver al Panel
                </button>
            </div>
        </div>

        <div class="panel-content">
            <!-- Alert Messages -->
            <div id="alertContainer"></div>

            <!-- C√≥digo y QR -->
            <div id="codeSection" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                <h3 style="color: #667eea; margin-bottom: 10px;">C√≥digo de Sala</h3>
                <div id="roomCodeDisplay" style="font-size: 48px; font-weight: bold; color: #333; margin: 20px 0; letter-spacing: 5px;">
                    -
                </div>
                <div id="qrCodeContainer" style="margin: 20px 0;"></div>
            </div>

            <!-- Estado de conexiones -->
            <div id="connectionStatus" style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                <h4 style="margin: 0; color: #856404;">‚è≥ Cargando...</h4>
            </div>

            <!-- Equipos -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #333;">Equipos (<span id="teamsCount">0</span>)</h3>
                    <button class="btn" onclick="shuffleAllTeams()" style="background: #28a745; font-size: 14px; padding: 8px 15px;">
                        üîÄ Reorganizar Todos Aleatoriamente
                    </button>
                </div>
                <div id="teamsList"></div>
            </div>

            <!-- Bot√≥n Iniciar Juego -->
            <div style="text-align: center; margin-top: 30px;">
                <button 
                    class="btn" 
                    id="startGameBtn"
                    onclick="startGame()" 
                    style="background: #6c757d; font-size: 18px; padding: 15px 40px; cursor: not-allowed;" 
                    disabled>
                    ‚è≥ Esperando conexi√≥n de tablets...
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api';
        let authToken = localStorage.getItem('authToken');
        let currentSessionId = null;

        // Obtener session_id de la URL
        const urlParts = window.location.pathname.split('/');
        const sessionIdIndex = urlParts.indexOf('lobby');
        if (sessionIdIndex !== -1 && urlParts[sessionIdIndex + 1]) {
            currentSessionId = parseInt(urlParts[sessionIdIndex + 1]);
        }

        // Verificar autenticaci√≥n al cargar
        if (!authToken) {
            window.location.href = '/login/';
        } else if (currentSessionId) {
            loadLobby();
        } else {
            showAlert('ID de sesi√≥n no v√°lido', 'error');
        }

        function showAlert(message, type = 'error') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        function getTeamColorHex(color) {
            const colorMap = {
                'Verde': '#28a745',
                'Azul': '#007bff',
                'Rojo': '#dc3545',
                'Amarillo': '#ffc107',
                'Naranja': '#fd7e14',
                'Morado': '#6f42c1',
                'Rosa': '#e83e8c',
                'Cian': '#17a2b8',
                'Gris': '#6c757d',
                'Marr√≥n': '#795548'
            };
            return colorMap[color] || '#667eea';
        }

        async function loadLobby() {
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/lobby/`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const lobbyData = await response.json();
                    const session = lobbyData.game_session;
                    
                    // Si el juego est√° corriendo, redirigir a la actividad actual
                    if (session.status === 'running') {
                        await determineAndRedirectToActivity(currentSessionId);
                        return;
                    }
                    
                    renderLobby(lobbyData);
                } else {
                    if (response.status === 401) {
                        window.location.href = '/login/';
                    } else if (response.status === 403) {
                        // Sesi√≥n finalizada
                        const errorData = await response.json().catch(() => ({}));
                        showAlert('La sesi√≥n ya ha finalizado. No puedes acceder al lobby.', 'error');
                        // Redirigir al panel despu√©s de 3 segundos
                        setTimeout(() => {
                            window.location.href = '/panel/';
                        }, 3000);
                    } else {
                        showAlert('Error al cargar el lobby de la sesi√≥n');
                    }
                }
            } catch (error) {
                showAlert('Error de conexi√≥n: ' + error.message);
            }
        }

        async function determineAndRedirectToActivity(sessionId) {
            try {
                // Obtener estado del juego
                const gameResponse = await fetch(`${API_BASE_URL}/sessions/game-sessions/${sessionId}/`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                if (!gameResponse.ok) {
                    return; // Si falla, quedarse en el lobby
                }

                const gameData = await gameResponse.json();
                const currentActivityName = gameData.current_activity_name;
                const currentActivityId = gameData.current_activity;
                const currentStageNumber = gameData.current_stage_number;

                // Si no hay actividad actual, ir a resultados
                if (!currentActivityName || !currentActivityId) {
                    if (currentStageNumber) {
                        window.location.href = `/profesor/resultados/${sessionId}/?stage_id=${currentStageNumber}`;
                    } else {
                        window.location.href = `/profesor/panel/`;
                    }
                    return;
                }

                // Normalizar nombre de actividad para comparaci√≥n
                const normalizedActivityName = currentActivityName.toLowerCase().trim();

                // Determinar URL seg√∫n actividad y etapa
                let redirectUrl = null;

                // Etapa 1: Trabajo en Equipo
                if (currentStageNumber === 1) {
                    if (normalizedActivityName.includes('personalizacion') || normalizedActivityName.includes('personalizaci√≥n')) {
                        redirectUrl = `/profesor/etapa1/personalizacion/${sessionId}/`;
                    } else if (normalizedActivityName.includes('presentacion') || normalizedActivityName.includes('presentaci√≥n')) {
                        redirectUrl = `/profesor/etapa1/presentacion/${sessionId}/`;
                    }
                }
                // Etapa 2: Empat√≠a
                else if (currentStageNumber === 2) {
                    if (normalizedActivityName.includes('tema') || normalizedActivityName.includes('seleccionar tema')) {
                        redirectUrl = `/profesor/etapa2/seleccionar-tema/${sessionId}/`;
                    } else if (normalizedActivityName.includes('desafio') || normalizedActivityName.includes('desaf√≠o') || normalizedActivityName.includes('challenge')) {
                        redirectUrl = `/profesor/etapa2/seleccionar-desafio/${sessionId}/`;
                    } else if (normalizedActivityName.includes('bubble') || normalizedActivityName.includes('mapa')) {
                        redirectUrl = `/profesor/etapa2/bubble-map/${sessionId}/`;
                    }
                }
                // Etapa 3: Creatividad
                else if (currentStageNumber === 3) {
                    if (normalizedActivityName.includes('prototipo')) {
                        redirectUrl = `/profesor/etapa3/prototipo/${sessionId}/`;
                    }
                }
                // Etapa 4: Comunicaci√≥n
                else if (currentStageNumber === 4) {
                    if ((normalizedActivityName.includes('pitch') && normalizedActivityName.includes('formulario')) ||
                        (normalizedActivityName.includes('formulario') && normalizedActivityName.includes('pitch'))) {
                        redirectUrl = `/profesor/etapa4/formulario-pitch/${sessionId}/`;
                    } else if (normalizedActivityName.includes('confirmar') && normalizedActivityName.includes('orden')) {
                        redirectUrl = `/profesor/etapa4/confirmar-orden-pitch/${sessionId}/`;
                    } else if ((normalizedActivityName.includes('pitch') && normalizedActivityName.includes('presentacion')) ||
                               (normalizedActivityName.includes('presentaci√≥n') && normalizedActivityName.includes('pitch')) ||
                               (normalizedActivityName.includes('presentacion') && !normalizedActivityName.includes('formulario'))) {
                        redirectUrl = `/profesor/etapa4/presentacion-pitch/${sessionId}/`;
                    }
                }

                // Si encontramos una URL, redirigir
                if (redirectUrl) {
                    window.location.href = redirectUrl;
                }
            } catch (error) {
                console.error('Error determining activity:', error);
            }
        }

        function renderLobby(lobbyData) {
            const session = lobbyData.game_session;
            const teams = lobbyData.teams;

            // Guardar datos de equipos para el modal
            allTeamsData = teams;

            // Actualizar c√≥digo de sala
            document.getElementById('roomCode').textContent = session.room_code;
            document.getElementById('roomCodeDisplay').textContent = session.room_code;

            // Mostrar QR Code
            const qrContainer = document.getElementById('qrCodeContainer');
            if (session.qr_code) {
                qrContainer.innerHTML = `
                    <div style="margin: 20px 0;">
                        <img src="${session.qr_code}" alt="QR Code" style="max-width: 200px; border: 2px solid #e0e0e0; border-radius: 10px;">
                    </div>
                    <p style="color: #666; font-size: 14px;">Escanea el c√≥digo QR con la tablet para conectarse</p>
                `;
            } else {
                qrContainer.innerHTML = '';
            }

            // Actualizar estado de conexiones
            const connectionStatus = document.getElementById('connectionStatus');
            if (lobbyData.all_teams_connected) {
                connectionStatus.style.background = '#d4edda';
                connectionStatus.innerHTML = '<h4 style="margin: 0; color: #155724;">‚úÖ Todas las tablets conectadas</h4>';
            } else {
                connectionStatus.style.background = '#fff3cd';
                connectionStatus.innerHTML = `<h4 style="margin: 0; color: #856404;">‚ö†Ô∏è ${lobbyData.connected_teams}/${lobbyData.total_teams} equipos conectados</h4>`;
            }

            // Actualizar contador de equipos
            document.getElementById('teamsCount').textContent = teams.length;

            // Renderizar equipos
            const teamsList = document.getElementById('teamsList');
            teamsList.innerHTML = teams.map(team => {
                const tabletConnection = lobbyData.tablet_connections.find(tc => tc.team === team.id);
                const isConnected = tabletConnection && tabletConnection.is_connected;
                
                return `
                    <div class="team-card" style="border-left: 5px solid ${getTeamColorHex(team.color)};" 
                         data-team-id="${team.id}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0; color: ${getTeamColorHex(team.color)};">
                                    ${team.name} 
                                    <span style="font-size: 14px; color: #666;">(${team.students_count} estudiantes)</span>
                                </h4>
                            </div>
                            <div style="text-align: right;">
                                <span style="padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${isConnected ? '#d4edda' : '#f8d7da'}; color: ${isConnected ? '#155724' : '#721c24'};">
                                    ${isConnected ? '‚úÖ Tablet Conectada' : '‚ùå Sin Tablet'}
                                </span>
                                ${tabletConnection ? `
                                    <button class="btn" onclick="disconnectTablet(${tabletConnection.id})" style="background: #dc3545; font-size: 12px; padding: 5px 10px; margin-top: 5px;">
                                        Desconectar
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <strong style="color: #666; font-size: 14px;">Estudiantes:</strong>
                            <div id="students-container-${team.id}" 
                                 style="margin-top: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; min-height: 50px;"
                                 ondrop="handleDrop(event, ${team.id})" 
                                 ondragover="handleDragOver(event)" 
                                 ondragenter="handleDragEnter(event)" 
                                 ondragleave="handleDragLeave(event)">
                                ${team.students ? team.students.map(student => {
                                    // Extraer primer nombre y apellido paterno
                                    const nameParts = student.full_name ? student.full_name.trim().split(/\s+/) : [];
                                    const firstName = nameParts[0] || '';
                                    
                                    let lastName = '';
                                    if (nameParts.length === 2) {
                                        lastName = nameParts[1];
                                    } else if (nameParts.length >= 3) {
                                        lastName = nameParts[nameParts.length - 2];
                                    }
                                    
                                    const shortName = lastName ? `${firstName} ${lastName}`.trim() : firstName || student.full_name || 'Sin nombre';
                                    
                                    return `
                                    <div draggable="true" 
                                         ondragstart="handleDragStart(event, ${student.id}, ${team.id})" 
                                         ondragend="handleDragEnd(event)"
                                         data-student-id="${student.id}"
                                         data-source-team-id="${team.id}"
                                         style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 14px; cursor: move; transition: all 0.2s; border: 2px solid transparent; user-select: none;"
                                         title="${student.full_name || ''} - Arrastra para mover a otro equipo">
                                        <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block;">${shortName}</span>
                                    </div>
                                `;
                                }).join('') : '<div style="grid-column: 1 / -1; text-align: center; color: #999; padding: 10px;">Sin estudiantes</div>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Actualizar bot√≥n de iniciar juego
            const startBtn = document.getElementById('startGameBtn');
            if (lobbyData.all_teams_connected) {
                startBtn.style.background = '#28a745';
                startBtn.style.cursor = 'pointer';
                startBtn.disabled = false;
                startBtn.textContent = 'üöÄ Iniciar Juego';
            } else {
                startBtn.style.background = '#6c757d';
                startBtn.style.cursor = 'not-allowed';
                startBtn.disabled = true;
                startBtn.textContent = '‚è≥ Esperando conexi√≥n de tablets...';
            }
        }

        let allTeamsData = [];
        let draggedStudentId = null;
        let draggedSourceTeamId = null;

        // Drag and Drop handlers
        function handleDragStart(event, studentId, sourceTeamId) {
            draggedStudentId = studentId;
            draggedSourceTeamId = sourceTeamId;
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', studentId);
            event.currentTarget.classList.add('student-dragging');
        }

        function handleDragEnd(event) {
            event.currentTarget.classList.remove('student-dragging');
            // Remover estilos de drag-over de todos los equipos
            document.querySelectorAll('.team-card').forEach(card => {
                card.classList.remove('drag-over');
            });
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(event) {
            event.preventDefault();
            const studentsContainer = event.currentTarget;
            const teamCard = studentsContainer.closest('.team-card');
            if (teamCard) {
                const targetTeamId = parseInt(teamCard.dataset.teamId);
                if (targetTeamId !== draggedSourceTeamId) {
                    teamCard.classList.add('drag-over');
                }
            }
        }

        function handleDragLeave(event) {
            const studentsContainer = event.currentTarget;
            const teamCard = studentsContainer.closest('.team-card');
            if (teamCard && !teamCard.contains(event.relatedTarget)) {
                teamCard.classList.remove('drag-over');
            }
        }

        async function handleDrop(event, targetTeamId) {
            event.preventDefault();
            event.stopPropagation();

            const studentsContainer = event.currentTarget;
            const teamCard = studentsContainer.closest('.team-card');
            if (teamCard) {
                teamCard.classList.remove('drag-over');
            }

            if (!draggedStudentId || !draggedSourceTeamId) {
                return;
            }

            // No hacer nada si se suelta en el mismo equipo
            if (targetTeamId === draggedSourceTeamId) {
                return;
            }

            // Mover estudiante autom√°ticamente
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/teams/${draggedSourceTeamId}/move_student/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        student_id: draggedStudentId,
                        target_team_id: targetTeamId
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Estudiante movido exitosamente', 'success');
                    // Recargar lobby
                    setTimeout(() => {
                        loadLobby();
                    }, 500);
                } else {
                    showAlert(data.error || 'Error al mover el estudiante', 'error');
                }
            } catch (error) {
                showAlert('Error de conexi√≥n: ' + error.message, 'error');
            } finally {
                // Limpiar variables
                draggedStudentId = null;
                draggedSourceTeamId = null;
            }
        }

        async function disconnectTablet(connectionId) {
            if (!confirm('¬øDesconectar esta tablet?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/tablet-connections/${connectionId}/disconnect/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    showAlert('Tablet desconectada exitosamente', 'success');
                    // Recargar lobby
                    setTimeout(() => {
                        loadLobby();
                    }, 1000);
                } else {
                    const data = await response.json();
                    showAlert(data.error || 'Error al desconectar tablet');
                }
            } catch (error) {
                showAlert('Error de conexi√≥n: ' + error.message);
            }
        }

        async function shuffleAllTeams() {
            if (!confirm('¬øReorganizar todos los estudiantes aleatoriamente?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/teams/shuffle_all/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ game_session_id: currentSessionId })
                });

                if (response.ok) {
                    showAlert('Estudiantes reorganizados exitosamente', 'success');
                    // Recargar lobby
                    setTimeout(() => {
                        loadLobby();
                    }, 1000);
                } else {
                    const data = await response.json();
                    showAlert(data.error || 'Error al reorganizar estudiantes');
                }
            } catch (error) {
                showAlert('Error de conexi√≥n: ' + error.message);
            }
        }

        async function startGame() {
            if (!confirm('¬øIniciar el juego? Todos los equipos deben tener su tablet conectada.')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/start/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                // Verificar que la respuesta sea JSON antes de parsear
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Respuesta no es JSON del endpoint start:', text);
                    throw new Error('El servidor devolvi√≥ una respuesta no v√°lida');
                }

                if (response.ok) {
                    const responseData = await response.json();
                    console.log('Juego iniciado:', responseData); // Debug
                    console.log('Current Session ID:', currentSessionId); // Debug
                    console.log('Redirigiendo a:', `/game-control/${currentSessionId}/`); // Debug
                    
                    // Verificar que currentSessionId sea v√°lido
                    if (!currentSessionId || isNaN(currentSessionId)) {
                        console.error('Error: currentSessionId no es v√°lido:', currentSessionId);
                        showAlert('Error: ID de sesi√≥n no v√°lido', 'error');
                        return;
                    }
                    
                    showAlert('¬°Juego iniciado exitosamente! Redirigiendo...', 'success');
                    // Redirigir a la vista de personalizaci√≥n (Etapa 1)
                    setTimeout(() => {
                        window.location.replace(`/profesor/etapa1/personalizacion/${currentSessionId}/`);
                    }, 500);
                } else {
                    // Intentar leer el error como JSON o texto
                    let errorMessage = 'Error al iniciar el juego';
                    try {
                        if (contentType && contentType.includes('application/json')) {
                            const data = await response.json();
                            errorMessage = data.error || errorMessage;
                        } else {
                            const errorText = await response.text();
                            console.error('Error del servidor (no JSON):', errorText);
                            errorMessage = 'Error al iniciar el juego. Por favor, verifica que todos los equipos est√©n conectados.';
                        }
                    } catch (e) {
                        console.error('Error al leer respuesta del servidor:', e);
                    }
                    console.error('Error al iniciar juego:', errorMessage); // Debug
                    showAlert(errorMessage);
                }
            } catch (error) {
                console.error('Error de conexi√≥n:', error); // Debug
                // Manejar errores de JSON parse espec√≠ficamente
                if (error.message && (error.message.includes('JSON.parse') || error.message.includes('Unexpected token') || error.message.includes('JSON'))) {
                    showAlert('Error de conexi√≥n: El servidor devolvi√≥ una respuesta no v√°lida. Por favor, verifica que todos los equipos est√©n conectados y recarga la p√°gina.', 'error');
                } else {
                    showAlert('Error de conexi√≥n: ' + error.message);
                }
            }
        }

        async function finalizeSession() {
            if (!confirm('¬øEst√°s seguro de que deseas finalizar esta sesi√≥n? Se desconectar√°n todas las tablets y no podr√°s acceder al lobby nuevamente.')) {
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n no se puede deshacer. ¬øContinuar?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/end/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showAlert(`¬°Sesi√≥n finalizada exitosamente! Se desconectaron ${data.tablets_disconnected || 0} tablets.`, 'success');
                    // Redirigir al panel despu√©s de 2 segundos
                    setTimeout(() => {
                        window.location.href = '/panel/';
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.error || 'Error al finalizar la sesi√≥n');
                }
            } catch (error) {
                showAlert('Error de conexi√≥n: ' + error.message);
            }
        }

        // Auto-refresh cada 5 segundos para actualizar estado de conexiones
        setInterval(() => {
            if (currentSessionId && authToken) {
                loadLobby();
            }
        }, 5000);
    </script>
</body>
</html>

