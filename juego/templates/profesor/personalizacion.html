<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misi√≥n Emprende - Personalizaci√≥n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .stage-info {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stage-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .stage-title {
            color: #667eea;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stage-description {
            color: #666;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .activity-info {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .activity-title {
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .progress-stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
        }

        .stat {
            padding: 15px 25px;
            background: white;
            border-radius: 10px;
            text-align: center;
            min-width: 150px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .teams-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .teams-section h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .team-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
            transition: all 0.3s;
        }

        .team-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .team-name-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .team-color {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            color: white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .team-info h3 {
            color: #333;
            font-size: 20px;
            margin-bottom: 5px;
        }

        .team-info p {
            color: #666;
            font-size: 14px;
        }

        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.in-progress {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.completed {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.pending {
            background: #f8d7da;
            color: #721c24;
        }

        .personalization-details {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .personalization-details h4 {
            color: #333;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .detail-item {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detail-label {
            color: #666;
            font-size: 14px;
            font-weight: 600;
            min-width: 120px;
        }

        .detail-value {
            color: #333;
            font-size: 14px;
        }

        .know-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .know-badge.yes {
            background: #d4edda;
            color: #155724;
        }

        .know-badge.no {
            background: #f8d7da;
            color: #721c24;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üë• Personalizaci√≥n</h1>
                <p id="roomCodeDisplay">Sala: <strong id="roomCode">---</strong></p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-danger" onclick="finalizeSession()">
                    üèÅ Finalizar Sala
                </button>
                <button class="btn" onclick="window.location.href='/panel/'">
                    ‚Üê Volver al Panel
                </button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- Informaci√≥n de Etapa -->
        <div class="stage-info">
            <div class="stage-icon" id="stageIcon">üë•</div>
            <h2 class="stage-title" id="stageTitle">Etapa 1: Trabajo en Equipo</h2>
            <p class="stage-description" id="stageDescription">
                Los equipos est√°n personalizando su nombre e indicando si se conocen
            </p>
            
            <div class="activity-info">
                <div class="activity-title">Actividad Actual: Personalizaci√≥n</div>
                <!-- Temporizador -->
                <div id="timerContainerProf" style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center; border: 2px solid #ffc107;">
                    <p style="margin: 0; color: #856404; font-weight: 600; font-size: 16px;">
                        ‚è±Ô∏è Tiempo restante: <span id="timerDisplayProf">--:--</span>
                    </p>
                </div>
                <div class="progress-stats">
                    <div class="stat">
                        <div class="stat-value" id="completedTeams">0</div>
                        <div class="stat-label">Completados</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="inProgressTeams">0</div>
                        <div class="stat-label">En Progreso</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="totalTeams">0</div>
                        <div class="stat-label">Total Equipos</div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" id="nextActivityBtn" onclick="nextActivity()" style="display: none;">
                    Continuar a Siguiente Actividad
                </button>
            </div>
        </div>

        <!-- Equipos -->
        <div class="teams-section">
            <h2>üë• Estado de Equipos</h2>
            <div class="teams-grid" id="teamsGrid">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Cargando equipos...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api';
        let authToken = localStorage.getItem('authToken');
        let currentSessionId = null;
        
        // Variables para temporizador
        let timerIntervalProf = null;
        let timerStartTimeProf = null;
        let timerDurationProf = null;

        // Obtener session_id de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const pathParts = window.location.pathname.split('/').filter(p => p);
        
        // Buscar en diferentes patrones de URL
        const personalizacionIndex = pathParts.indexOf('personalizacion');
        const gameControlIndex = pathParts.indexOf('game-control');
        
        if (personalizacionIndex !== -1 && pathParts[personalizacionIndex + 1]) {
            currentSessionId = parseInt(pathParts[personalizacionIndex + 1]);
        } else if (gameControlIndex !== -1 && pathParts[gameControlIndex + 1]) {
            currentSessionId = parseInt(pathParts[gameControlIndex + 1]);
        } else {
            currentSessionId = urlParams.get('session_id') ? parseInt(urlParams.get('session_id')) : null;
        }
        
        console.log('üîç Current Session ID:', currentSessionId, 'from path:', window.location.pathname); // Debug
        console.log('üîç URL completa:', window.location.href); // Debug
        
        if (!authToken) {
            console.error('‚ùå No hay token de autenticaci√≥n, redirigiendo a login');
            window.location.href = '/login/';
        } else {
            console.log('‚úÖ Token de autenticaci√≥n presente'); // Debug

            if (!currentSessionId || isNaN(currentSessionId)) {
                console.error('Session ID no v√°lido:', currentSessionId); // Debug
                // Mostrar alerta antes de redirigir
                setTimeout(() => {
                    window.location.href = '/panel/';
                }, 2000);
            } else {
                // C√≥digo principal solo se ejecuta si hay token y sessionId v√°lido
                initializePage();
            }
        }

        function initializePage() {
            // Cargar estado inicial
            console.log('üîÑ Iniciando carga de datos de personalizaci√≥n...'); // Debug
            const loadingEl = document.getElementById('loading');
            if (loadingEl) {
                loadingEl.classList.add('show');
            } else {
                console.warn('‚ö†Ô∏è Elemento loading no encontrado en el DOM');
            }
            
            // Cargar datos inmediatamente
            loadGameControl();

            // Polling cada 2 segundos para actualizar estado en tiempo real
            const pollInterval = setInterval(() => {
                loadGameControl();
            }, 2000);

            // Limpiar intervalo cuando se cierra la p√°gina
            window.addEventListener('beforeunload', () => {
                if (pollInterval) {
                    clearInterval(pollInterval);
                }
            });
        }

        function showAlert(message, type = 'error') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        function getTeamColorHex(color) {
            const colorMap = {
                'Verde': '#28a745',
                'Azul': '#007bff',
                'Rojo': '#dc3545',
                'Amarillo': '#ffc107',
                'Naranja': '#fd7e14',
                'Morado': '#6f42c1',
                'Rosa': '#e83e8c',
                'Cian': '#17a2b8',
                'Gris': '#6c757d',
                'Marr√≥n': '#795548'
            };
            return colorMap[color] || '#667eea';
        }

        async function loadGameControl() {
            try {
                if (!currentSessionId || isNaN(currentSessionId)) {
                    console.error('Error: currentSessionId no es v√°lido:', currentSessionId);
                    showAlert('Error: ID de sesi√≥n no v√°lido', 'error');
                    return;
                }

                console.log('Cargando sesi√≥n ID:', currentSessionId); // Debug
                
                // Obtener informaci√≥n de la sesi√≥n
                console.log('üîç Haciendo petici√≥n a:', `${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/`);
                console.log('üîë Token de autenticaci√≥n:', authToken ? 'Presente' : 'Ausente');
                
                const sessionResponse = await fetch(`${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì° Respuesta de sesi√≥n:', sessionResponse.status, sessionResponse.statusText);

                if (!sessionResponse.ok) {
                    const errorData = await sessionResponse.json().catch(() => {
                        return { error: 'Error desconocido', detail: sessionResponse.statusText };
                    });
                    console.error('‚ùå Error al cargar sesi√≥n:', sessionResponse.status, errorData);
                    showAlert(`Error al cargar la sesi√≥n (${sessionResponse.status}): ${errorData.error || errorData.detail || 'Error desconocido'}`, 'error');
                    return;
                }

                const sessionData = await sessionResponse.json();
                console.log('‚úÖ Session Data recibida:', sessionData); // Debug
                console.log('   - room_code:', sessionData.room_code);
                console.log('   - status:', sessionData.status);
                console.log('   - current_stage_name:', sessionData.current_stage_name);
                console.log('   - current_activity_name:', sessionData.current_activity_name);
                console.log('   - current_stage_number:', sessionData.current_stage_number);
                
                // Validar que estamos en la Etapa 1
                const currentStageNumber = sessionData.current_stage_number || 0;
                if (currentStageNumber !== 1) {
                    console.warn('‚ö†Ô∏è Esta vista es para Etapa 1, pero la sesi√≥n est√° en Etapa', currentStageNumber);
                    // Redirigir a la vista correcta seg√∫n la etapa
                    if (currentStageNumber === 2) {
                        if (sessionData.current_activity_name && (
                            sessionData.current_activity_name.toLowerCase().includes('tema') || 
                            sessionData.current_activity_name.toLowerCase().includes('seleccionar')
                        )) {
                            window.location.replace(`/profesor/etapa2/seleccionar-tema/${currentSessionId}/`);
                            return;
                        } else if (sessionData.current_activity_name && (
                            sessionData.current_activity_name.toLowerCase().includes('desaf√≠o') || 
                            sessionData.current_activity_name.toLowerCase().includes('desafio')
                        )) {
                            window.location.replace(`/profesor/etapa2/ver-desafio/${currentSessionId}/`);
                            return;
                        } else if (sessionData.current_activity_name && (
                            sessionData.current_activity_name.toLowerCase().includes('bubble') || 
                            sessionData.current_activity_name.toLowerCase().includes('mapa')
                        )) {
                            window.location.replace(`/profesor/etapa2/bubble-map/${currentSessionId}/`);
                            return;
                        } else {
                            window.location.replace(`/profesor/etapa2/seleccionar-tema/${currentSessionId}/`);
                            return;
                        }
                    } else if (currentStageNumber === 3) {
                        window.location.replace(`/profesor/etapa3/prototipo/${currentSessionId}/`);
                        return;
                    } else if (currentStageNumber === 4) {
                        // Redirigir a la primera actividad de la Etapa 4
                        if (sessionData.current_activity_name && (
                            sessionData.current_activity_name.toLowerCase().includes('pitch') || 
                            sessionData.current_activity_name.toLowerCase().includes('formulario')
                        )) {
                            window.location.replace(`/profesor/etapa4/formulario-pitch/${currentSessionId}/`);
                        } else {
                            window.location.replace(`/profesor/etapa4/formulario-pitch/${currentSessionId}/`);
                        }
                        return;
                    }
                }
                
                // Actualizar c√≥digo de sala
                const roomCodeEl = document.getElementById('roomCode');
                if (roomCodeEl) {
                    if (sessionData.room_code) {
                        roomCodeEl.textContent = sessionData.room_code;
                        console.log('‚úÖ C√≥digo de sala actualizado:', sessionData.room_code); // Debug
                    } else {
                        console.warn('‚ö†Ô∏è room_code no est√° disponible en sessionData:', sessionData);
                        roomCodeEl.textContent = '---';
                    }
                } else {
                    console.error('‚ùå Elemento roomCode no encontrado en el DOM');
                }
                
                // Actualizar informaci√≥n de etapa y actividad
                // Mostrar informaci√≥n de Etapa 1 (fija para esta vista)
                document.getElementById('stageTitle').textContent = 'Etapa 1: Trabajo en Equipo';
                
                // Actualizar descripci√≥n de actividad (solo si es Personalizaci√≥n)
                if (sessionData.current_activity_name && sessionData.current_activity_name.toLowerCase().includes('personaliz')) {
                    document.getElementById('stageDescription').textContent = `Actividad Actual: ${sessionData.current_activity_name}`;
                } else {
                    document.getElementById('stageDescription').textContent = 'Actividad Actual: Personalizaci√≥n';
                }
                
                // Guardar datos de sesi√≥n para sincronizaci√≥n
                sessionStorage.setItem('lastSessionData', JSON.stringify({
                    current_activity: sessionData.current_activity,
                    started_at: sessionData.started_at
                }));
                
                // Iniciar temporizador si hay actividad actual
                if (sessionData.current_activity && !timerIntervalProf) {
                    startTimerProf(sessionData.current_activity, sessionData.started_at);
                }

                // Obtener equipos con personalizaci√≥n
                console.log('üîç Obteniendo equipos para sesi√≥n:', currentSessionId);
                const teamsResponse = await fetch(`${API_BASE_URL}/sessions/teams/?game_session=${currentSessionId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì° Respuesta de equipos:', teamsResponse.status, teamsResponse.statusText);

                if (!teamsResponse.ok) {
                    const errorData = await teamsResponse.json().catch(() => ({}));
                    console.error('‚ùå Error al cargar equipos:', teamsResponse.status, errorData);
                    showAlert(`Error al cargar los equipos (${teamsResponse.status}): ${errorData.error || errorData.detail || ''}`, 'error');
                    return;
                }

                const teamsData = await teamsResponse.json();
                console.log('‚úÖ Teams Data recibida:', teamsData); // Debug
                const teams = teamsData.results || teamsData;
                console.log('üìä Equipos encontrados:', teams.length, teams); // Debug
                
                if (teams.length === 0) {
                    console.warn('‚ö†Ô∏è No se encontraron equipos para esta sesi√≥n');
                }

                // Obtener personalizaciones de todos los equipos
                const personalizations = {};
                console.log('üîç Obteniendo personalizaciones para', teams.length, 'equipos');
                
                for (const team of teams) {
                    try {
                        console.log(`  üìã Obteniendo personalizaci√≥n para equipo ${team.id} (${team.name || 'Sin nombre'})`);
                        const persResponse = await fetch(`${API_BASE_URL}/sessions/team-personalizations/?team=${team.id}`, {
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        console.log(`    üì° Respuesta: ${persResponse.status} ${persResponse.statusText}`);
                        
                        if (persResponse.ok) {
                            const persData = await persResponse.json();
                            const persResults = persData.results || persData;
                            console.log(`    üìä Personalizaciones encontradas: ${persResults.length}`, persResults);
                            if (persResults.length > 0) {
                                personalizations[team.id] = persResults[0];
                                console.log(`    ‚úÖ Personalizaci√≥n guardada para equipo ${team.id}:`, persResults[0]);
                            } else {
                                console.log(`    ‚ö†Ô∏è No hay personalizaci√≥n para equipo ${team.id}`);
                            }
                        } else {
                            const errorData = await persResponse.json().catch(() => ({}));
                            console.warn(`    ‚ö†Ô∏è Error al obtener personalizaci√≥n para equipo ${team.id}:`, persResponse.status, errorData);
                        }
                    } catch (error) {
                        console.error(`    ‚ùå Error loading personalization for team ${team.id}:`, error);
                    }
                }
                
                console.log('üìù Total personalizaciones obtenidas:', Object.keys(personalizations).length, personalizations);

                // Renderizar equipos
                console.log('Personalizaciones encontradas:', Object.keys(personalizations).length); // Debug
                console.log('Total equipos a renderizar:', teams.length); // Debug
                renderTeams(teams, personalizations);

                // Ocultar loading
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.classList.remove('show');
                }
            } catch (error) {
                console.error('Error loading game control:', error);
                showAlert('Error de conexi√≥n: ' + error.message, 'error');
            }
        }

        function renderTeams(teams, personalizations) {
            const teamsGrid = document.getElementById('teamsGrid');
            
            // Limpiar loading si existe
            const loadingElement = teamsGrid.querySelector('.loading');
            if (loadingElement) {
                loadingElement.remove();
            }
            
            let completedCount = 0;
            let inProgressCount = 0;

            if (teams.length === 0) {
                teamsGrid.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No hay equipos en esta sesi√≥n.</p>';
                return;
            }

            teamsGrid.innerHTML = teams.map(team => {
                const personalization = personalizations[team.id] || null;
                const isCompleted = personalization && 
                                   personalization.team_name && 
                                   personalization.team_name.trim() !== '' &&
                                   personalization.team_members_know_each_other !== null;
                
                if (isCompleted) {
                    completedCount++;
                } else {
                    // En Progreso: todos los que no est√°n completados (pendientes + parciales)
                    inProgressCount++;
                }

                const status = isCompleted ? 'completed' : (personalization ? 'in-progress' : 'pending');
                const statusText = isCompleted ? 'Listo' : (personalization ? 'En Progreso' : 'Pendiente');

                return `
                    <div class="team-card" style="border-left-color: ${getTeamColorHex(team.color)};">
                        <div class="team-header">
                            <div class="team-name-section">
                                <div class="team-color" style="background: ${getTeamColorHex(team.color)};">
                                    ${team.color.charAt(0).toUpperCase()}
                                </div>
                                <div class="team-info">
                                    <h3>${team.name}</h3>
                                    <p>${team.students_count} estudiantes</p>
                                </div>
                            </div>
                            <div class="status-badge ${status}">
                                ${statusText}
                            </div>
                        </div>

                        <div class="personalization-details">
                            <h4>üìù Personalizaci√≥n</h4>
                            ${personalization ? `
                                <div class="detail-item">
                                    <span class="detail-label">Nombre del Equipo:</span>
                                    <span class="detail-value">
                                        ${personalization.team_name || '<em style="color: #999;">No definido</em>'}
                                    </span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">¬øSe conocen?:</span>
                                    <span class="detail-value">
                                        ${personalization.team_members_know_each_other !== null ? 
                                            (personalization.team_members_know_each_other ? 
                                                '<span class="know-badge yes">‚úÖ S√≠, ya se conocen</span>' : 
                                                '<span class="know-badge no">‚ùå No se conocen</span>') : 
                                            '<em style="color: #999;">No indicado</em>'}
                                    </span>
                                </div>
                            ` : `
                                <div class="detail-item">
                                    <span class="detail-value" style="color: #999;">A√∫n no ha iniciado la personalizaci√≥n</span>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');

            // Actualizar estad√≠sticas
            document.getElementById('completedTeams').textContent = completedCount;
            document.getElementById('inProgressTeams').textContent = inProgressCount;
            document.getElementById('totalTeams').textContent = teams.length;

            // Mostrar bot√≥n de continuar si todos est√°n completos
            const nextBtn = document.getElementById('nextActivityBtn');
            if (completedCount === teams.length && teams.length > 0) {
                nextBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'none';
            }
        }

        async function nextActivity() {
            if (!confirm('¬øAvanzar a la siguiente actividad? Todos los equipos deben haber completado la actividad actual.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/next_activity/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Si se complet√≥ la etapa, redirigir a resultados
                    if (data.stage_completed) {
                        showAlert(`¬°${data.message}`, 'success');
                        setTimeout(() => {
                            window.location.replace(`/profesor/resultados/${currentSessionId}/?stage_id=${data.stage_id}`);
                        }, 1500);
                    } else {
                        const nextActivityName = data.current_activity_name;
                        
                        if (nextActivityName === 'Presentaci√≥n') {
                            showAlert('¬°Avanzando a la actividad de Presentaci√≥n!', 'success');
                            setTimeout(() => {
                                window.location.replace(`/profesor/etapa1/presentacion/${currentSessionId}/`);
                            }, 1500);
                        } else if (nextActivityName && (nextActivityName.toLowerCase().includes('tema') || nextActivityName.toLowerCase().includes('seleccionar'))) {
                            showAlert('¬°Avanzando a selecci√≥n de tema!', 'success');
                            setTimeout(() => {
                                window.location.replace(`/profesor/etapa2/seleccionar-tema/${currentSessionId}/`);
                            }, 1500);
                        } else if (nextActivityName && (nextActivityName.toLowerCase().includes('desaf√≠o') || nextActivityName.toLowerCase().includes('desafio'))) {
                            showAlert('¬°Avanzando a ver desaf√≠o!', 'success');
                            setTimeout(() => {
                                window.location.replace(`/profesor/etapa2/ver-desafio/${currentSessionId}/`);
                            }, 1500);
                        } else if (nextActivityName && nextActivityName.toLowerCase().includes('bubble')) {
                            showAlert('¬°Avanzando a bubble map!', 'success');
                            setTimeout(() => {
                                window.location.replace(`/profesor/etapa2/bubble-map/${currentSessionId}/`);
                            }, 1500);
                        } else {
                            showAlert(`Actividad actualizada a: ${nextActivityName}`, 'success');
                            // Recargar datos
                            loadGameControl();
                        }
                    }
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.error || 'Error al avanzar a la siguiente actividad', 'error');
                }
            } catch (error) {
                showAlert('Error de conexi√≥n: ' + error.message, 'error');
            }
        }

        async function startTimerProf(activityId, sessionStartedAt) {
            try {
                // Intentar restaurar desde sessionStorage primero
                const storedTimerStart = sessionStorage.getItem(`timerStartTimeProf_${currentSessionId}_${activityId}`);
                const storedTimerDuration = sessionStorage.getItem(`timerDurationProf_${currentSessionId}_${activityId}`);
                
                if (storedTimerStart && storedTimerDuration) {
                    const storedDuration = parseInt(storedTimerDuration);
                    // Solo restaurar si la duraci√≥n es v√°lida
                    if (storedDuration && storedDuration > 0) {
                        timerStartTimeProf = parseInt(storedTimerStart);
                        timerDurationProf = storedDuration;
                        console.log('‚úÖ Temporizador restaurado desde sessionStorage:', {
                            startTime: new Date(timerStartTimeProf).toISOString(),
                            duration: timerDurationProf
                        });
                    } else {
                        // Si la duraci√≥n almacenada no es v√°lida, limpiar y obtener del servidor
                        sessionStorage.removeItem(`timerStartTimeProf_${currentSessionId}_${activityId}`);
                        sessionStorage.removeItem(`timerDurationProf_${currentSessionId}_${activityId}`);
                    }
                }
                
                // Si no se restaur√≥ desde sessionStorage o no era v√°lido, obtener del servidor
                if (!timerStartTimeProf || !timerDurationProf) {
                    // Obtener informaci√≥n del temporizador desde el endpoint centralizado
                    const timerResponse = await fetch(`${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/activity_timer/`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!timerResponse.ok) {
                        throw new Error('Error al obtener informaci√≥n del temporizador');
                    }
                    
                    const timerData = await timerResponse.json();
                    
                    if (timerData.error) {
                        throw new Error(timerData.error);
                    }
                    
                    timerDurationProf = timerData.timer_duration; // En segundos (desde el modelo, puede ser null)
                    
                    // Validar que timer_duration est√© configurado
                    if (timerDurationProf === null || timerDurationProf === undefined) {
                        console.warn('‚ö†Ô∏è La actividad no tiene timer_duration configurado. No se puede iniciar el temporizador.');
                        showAlert('La actividad no tiene tiempo configurado. Por favor, config√∫relo en el admin de Django.', 'error');
                        return;
                    }
                    
                    if (timerData.started_at) {
                        timerStartTimeProf = new Date(timerData.started_at).getTime();
                    } else {
                        // Si no hay started_at, usar el tiempo actual del servidor
                        timerStartTimeProf = new Date(timerData.current_time).getTime();
                    }
                    
                    // Guardar en sessionStorage para persistir entre recargas (solo si timerDurationProf es v√°lido)
                    if (timerDurationProf !== null && timerDurationProf !== undefined) {
                        sessionStorage.setItem(`timerStartTimeProf_${currentSessionId}_${activityId}`, timerStartTimeProf.toString());
                        sessionStorage.setItem(`timerDurationProf_${currentSessionId}_${activityId}`, timerDurationProf.toString());
                    }
                    
                    console.log('‚úÖ Temporizador inicializado desde servidor:', {
                        activityId: activityId,
                        duration: timerDurationProf,
                        startedAt: timerData.started_at
                    });
                }
                
                // Continuar con la l√≥gica del temporizador (solo si timerDurationProf es v√°lido)
                if (!timerDurationProf || timerDurationProf <= 0) {
                    console.warn('‚ö†Ô∏è No se puede iniciar el temporizador: timerDurationProf no es v√°lido');
                    return;
                }
                
                const timerDisplay = document.getElementById('timerDisplayProf');
                if (timerDisplay) {
                    const updateTimer = () => {
                        if (!timerStartTimeProf || !timerDurationProf) {
                            return; // No actualizar si faltan datos
                        }
                        const elapsed = Math.floor((Date.now() - timerStartTimeProf) / 1000);
                        const remaining = Math.max(0, timerDurationProf - elapsed);
                        
                        const minutes = Math.floor(remaining / 60);
                        const seconds = remaining % 60;
                        timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                        
                        if (remaining <= 0) {
                            clearInterval(timerIntervalProf);
                            timerIntervalProf = null;
                            timerDisplay.textContent = '00:00';
                        }
                    };
                    
                    updateTimer();
                    if (!timerIntervalProf) {
                        timerIntervalProf = setInterval(updateTimer, 1000);
                    }
                }
            } catch (error) {
                console.error('Error starting timer:', error);
                showAlert('Error al iniciar temporizador: ' + error.message, 'error');
            }
        }

        async function syncTimerProfFromServer(gameSessionId, activityId) {
            try {
                const timerResponse = await fetch(`${API_BASE_URL}/sessions/game-sessions/${gameSessionId}/activity_timer/`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (timerResponse.ok) {
                    const timerData = await timerResponse.json();
                    
                    if (timerData.error) {
                        console.error('Error del servidor:', timerData.error);
                        return;
                    }
                    
                    // Actualizar timerDuration si cambi√≥ (administradora puede haberlo modificado)
                    if (timerData.timer_duration !== timerDurationProf) {
                        timerDurationProf = timerData.timer_duration;
                        sessionStorage.setItem(`timerDurationProf_${currentSessionId}_${activityId}`, timerDurationProf.toString());
                        console.log('üîÑ Duraci√≥n del temporizador actualizada desde servidor:', timerDurationProf);
                    }
                    
                    // Sincronizar started_at si est√° disponible
                    if (timerData.started_at) {
                        const serverStartTime = new Date(timerData.started_at).getTime();
                        const currentStartTime = timerStartTimeProf;
                        
                        // Si hay diferencia significativa (> 2 segundos), sincronizar
                        if (!currentStartTime || Math.abs(serverStartTime - currentStartTime) > 2000) {
                            timerStartTimeProf = serverStartTime;
                            sessionStorage.setItem(`timerStartTimeProf_${currentSessionId}_${activityId}`, timerStartTimeProf.toString());
                            console.log('üîÑ Temporizador sincronizado desde servidor');
                        }
                    }
                }
            } catch (error) {
                console.error('Error sincronizando temporizador:', error);
            }
        }

        async function finalizeSession() {
            if (!confirm('¬øEst√°s seguro de que deseas finalizar esta sesi√≥n? Se desconectar√°n todas las tablets y no podr√°s acceder al lobby nuevamente.')) {
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ADVERTENCIA: Esta acci√≥n no se puede deshacer. ¬øContinuar?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/end/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showAlert(`¬°Sesi√≥n finalizada exitosamente! Se desconectaron ${data.tablets_disconnected || 0} tablets.`, 'success');
                    // Redirigir al panel despu√©s de 2 segundos
                    setTimeout(() => {
                        window.location.href = '/panel/';
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.error || 'Error al finalizar la sesi√≥n');
                }
            } catch (error) {
                showAlert('Error de conexi√≥n: ' + error.message);
            }
        }

    </script>
</body>
</html>

