<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misi√≥n Emprende - Presentaci√≥n del Pitch</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            margin-left: 10px;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .stage-info {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stage-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .stage-title {
            color: #667eea;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .presentation-controls {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .presentation-controls h2 {
            color: #667eea;
            font-size: 20px;
            margin-bottom: 20px;
        }

        .order-section {
            margin-bottom: 25px;
        }

        .order-section h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .order-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .order-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 2px solid transparent;
        }

        .order-item.current {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .order-number {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
        }

        .order-item.current .order-number {
            background: #ffc107;
            color: #000;
        }

        .team-info {
            flex: 1;
        }

        .team-name {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .team-color {
            color: #666;
            font-size: 14px;
        }

        .current-badge {
            background: #28a745;
            color: white;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: auto;
        }

        .teams-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .teams-section h2 {
            color: #667eea;
            font-size: 20px;
            margin-bottom: 20px;
        }

        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .team-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid transparent;
        }

        .team-card.presenting {
            border-color: #ffc107;
            background: #fff3cd;
        }

        .team-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .team-color-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
        }

        .team-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .evaluations-list {
            margin-top: 15px;
        }

        .evaluation-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .evaluation-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .evaluation-score {
            font-weight: 600;
            color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .drag-handle {
            cursor: move;
            color: #999;
            font-size: 18px;
        }

        .drag-handle:hover {
            color: #667eea;
        }

        .order-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-left: 10px;
        }

        .order-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .order-btn:hover {
            background: #5568d3;
        }

        .order-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .order-btn.up {
            border-radius: 5px 5px 0 0;
        }

        .order-btn.down {
            border-radius: 0 0 5px 5px;
        }

        .order-item.dragging {
            opacity: 0.5;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tabs-container {
            position: relative;
        }

        .tabs {
            display: flex;
            gap: 0;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #666;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #667eea;
            background: #f5f5f5;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: block;
        }

        .tab-content.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üì¢ Presentaci√≥n del Pitch</h1>
                <p>Etapa 4: Comunicaci√≥n</p>
            </div>
            <div>
                <button class="btn" onclick="window.location.href='/panel/'">‚Üê Volver al Panel</button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="stage-info">
            <div class="stage-icon">üì¢</div>
            <h2 class="stage-title">Etapa 4: Comunicaci√≥n</h2>
            <p style="color: #666; margin-top: 10px;">Los equipos presentan su pitch y reciben evaluaci√≥n de sus compa√±eros</p>
        </div>

        <!-- Tabs para separar Configuraci√≥n y Presentaciones -->
        <div class="tabs-container" style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);">
            <div class="tabs" style="display: flex; gap: 10px; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px;">
                <button class="tab-btn active" onclick="switchTab('config')" id="tabConfig">
                    ‚öôÔ∏è Configurar Orden
                </button>
                <button class="tab-btn" onclick="switchTab('presentations')" id="tabPresentations">
                    üé§ Presentaciones
                </button>
            </div>

            <!-- Tab 1: Configurar Orden -->
            <div id="tabContentConfig" class="tab-content" style="display: block;">
                <div class="order-section">
                    <h3 style="margin-bottom: 15px;">Orden de Presentaci√≥n</h3>
                    <p style="color: #666; margin-bottom: 15px;">Configura el orden en que los equipos presentar√°n. Puedes mover los equipos arriba o abajo.</p>
                    
                    <div id="orderList" class="order-list">
                        <p style="color: #666; text-align: center; padding: 20px;">
                            Genera un orden de presentaci√≥n para comenzar
                        </p>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="startPresentations()" id="startPresentationsBtn" style="display: none;">
                            ‚ñ∂Ô∏è Iniciar Presentaciones
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Presentaciones -->
            <div id="tabContentPresentations" class="tab-content" style="display: none;">
                <!-- Orden de presentaci√≥n (peque√±o) -->
                <div id="presentationOrderSummary" style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none;">
                    <h4 style="font-size: 14px; color: #666; margin-bottom: 10px;">üìã Orden de Presentaci√≥n:</h4>
                    <div id="presentationOrderSummaryList" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
                </div>

                <!-- Estado actual: Preparaci√≥n -->
                <div id="preparingState" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 15px; text-align: center; color: white; margin-bottom: 20px;">
                    <div style="font-size: 80px; margin-bottom: 20px;">üé§</div>
                    <h2 style="color: white; font-size: 32px; font-weight: 700; margin-bottom: 15px;" id="preparingTeamName">Iniciar Pitch del Equipo...</h2>
                    <p style="color: rgba(255,255,255,0.9); font-size: 20px; margin-bottom: 30px;">El equipo debe prepararse para presentar. Pueden decidir qui√©n presenta, revisar su pitch, etc.</p>
                    <p style="color: rgba(255,255,255,0.8); font-size: 16px; margin-bottom: 30px;">Presiona el bot√≥n cuando el equipo est√© listo para comenzar su presentaci√≥n de 3 minutos.</p>
                    <button class="btn btn-success" onclick="startCurrentTeamPitch()" id="startCurrentTeamPitchBtn" style="background: white; color: #667eea; font-size: 18px; padding: 15px 30px;">
                        ‚ñ∂Ô∏è Iniciar Pitch - <span id="startPitchTeamName"></span>
                    </button>
                </div>

                <!-- Estado actual: Presentando -->
                <div id="presentingState" style="display: none; background: #d4edda; padding: 30px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #28a745;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üé§</div>
                        <h3 style="color: #155724; font-size: 24px; font-weight: 700; margin-bottom: 10px;" id="presentingTeamName">Equipo Presentando...</h3>
                        <p style="color: #155724; font-size: 16px;">El equipo est√° presentando su pitch</p>
                    </div>
                    
                    <!-- Cron√≥metro -->
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #ffc107; margin-bottom: 20px;">
                        <p style="margin: 0; color: #856404; font-weight: 600; font-size: 24px;">
                            ‚è±Ô∏è Tiempo: <span id="professorTimerDisplay">03:00</span>
                        </p>
                    </div>

                    <!-- Prototipo y Pitch -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <!-- Prototipo -->
                        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h4 style="color: #333; font-size: 18px; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                üì∑ Prototipo del Equipo
                            </h4>
                            <div id="professorPrototypeContainer">
                                <p style="color: #999; text-align: center; padding: 20px; font-style: italic;">Cargando prototipo...</p>
                            </div>
                        </div>

                        <!-- Guion del Pitch -->
                        <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h4 style="color: #333; font-size: 18px; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                üìù Guion del Pitch
                            </h4>
                            <div id="professorPitchContainer">
                                <p style="color: #999; text-align: center; padding: 20px; font-style: italic;">Cargando guion...</p>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center;">
                        <button class="btn btn-danger" onclick="finishCurrentPresentation()" id="finishCurrentPresentationBtn">
                            ‚úì Finalizar Presentaci√≥n - <span id="finishPitchTeamName"></span>
                        </button>
                    </div>
                </div>

                <!-- Estado actual: Evaluando -->
                <div id="evaluatingState" style="display: none; background: #fff3cd; padding: 30px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #ffc107;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚≠ê</div>
                        <h3 style="color: #856404; font-size: 24px; font-weight: 700; margin-bottom: 10px;">Evaluaci√≥n - <span id="evaluatingTeamName"></span></h3>
                        <p style="color: #856404; font-size: 16px;">Los otros equipos est√°n evaluando al equipo que acaba de presentar</p>
                    </div>

                    <!-- Progreso de evaluaciones -->
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #333; font-size: 18px; margin-bottom: 15px;">üìä Progreso de Evaluaciones:</h4>
                        <div id="evaluationProgress" style="margin-bottom: 15px;">
                            <p style="color: #666;">Cargando...</p>
                        </div>
                        <div style="background: #e9ecef; border-radius: 5px; height: 20px; overflow: hidden;">
                            <div id="evaluationProgressBar" style="background: #28a745; height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <p style="color: #666; font-size: 14px; margin-top: 10px;" id="evaluationProgressText">0 de 0 equipos han evaluado</p>
                    </div>

                    <div style="text-align: center;">
                        <button class="btn btn-success" onclick="nextPresentation()" id="nextPresentationBtn" style="display: none;">
                            ‚û°Ô∏è Siguiente Turno
                        </button>
                        <button class="btn btn-primary" onclick="goToFinalResults()" id="goToFinalResultsBtn" style="display: none;">
                            üèÜ Ir a Resultados Finales
                        </button>
                        <p id="waitingEvaluationsText" style="color: #856404; font-weight: 600;">Esperando a que todos los equipos completen su evaluaci√≥n...</p>
                    </div>
                </div>

                <!-- Estado: Todas las presentaciones completadas -->
                <div id="completedState" style="display: none; background: #d1ecf1; padding: 40px; border-radius: 15px; text-align: center; margin-bottom: 20px; border: 2px solid #0c5460;">
                    <div style="font-size: 80px; margin-bottom: 20px;">üéâ</div>
                    <h2 style="color: #0c5460; font-size: 32px; font-weight: 700; margin-bottom: 15px;">¬°Todas las Presentaciones Completadas!</h2>
                    <p style="color: #0c5460; font-size: 20px; margin-bottom: 30px;">Todos los equipos han presentado y sido evaluados</p>
                    <button class="btn btn-warning" onclick="goToResults()" id="goToResultsBtn" style="font-size: 18px; padding: 15px 30px;">
                        üèÜ Ver Resultados Finales
                    </button>
                </div>
            </div>
        </div>

        <div class="teams-section">
            <h2>üë• Equipos y Evaluaciones</h2>
            <div id="loading" class="loading">
                <div style="border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                <p style="margin-top: 15px; color: #666;">Cargando equipos...</p>
            </div>
            <div id="teamsGrid" class="teams-grid" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api';
        const currentSessionId = {{ session_id }};
        let currentSessionStageId = null;
        let presentationOrder = [];
        let currentPresentationTeamId = null;
        let presentationState = 'not_started';
        let professorTimerInterval = null;
        let professorTimerSeconds = 180; // 3 minutos = 180 segundos
        let currentTab = 'config';

        // Funci√≥n para cambiar de tab
        function switchTab(tab) {
            console.log('üîÑ [switchTab] Cambiando a tab:', tab);
            currentTab = tab;
            
            // Desactivar todos los botones de tab
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            // Ocultar todos los contenidos de tabs
            const tabConfig = document.getElementById('tabContentConfig');
            const tabPresentations = document.getElementById('tabContentPresentations');
            
            if (tabConfig) tabConfig.style.display = 'none';
            if (tabPresentations) tabPresentations.style.display = 'none';
            
            if (tab === 'config') {
                const tabBtn = document.getElementById('tabConfig');
                if (tabBtn) tabBtn.classList.add('active');
                if (tabConfig) tabConfig.style.display = 'block';
                console.log('‚úÖ [switchTab] Tab config activado');
            } else if (tab === 'presentations') {
                const tabBtn = document.getElementById('tabPresentations');
                if (tabBtn) tabBtn.classList.add('active');
                if (tabPresentations) tabPresentations.style.display = 'block';
                console.log('‚úÖ [switchTab] Tab presentations activado');
                // Cargar datos de presentaci√≥n cuando se cambia a este tab
                loadPresentationData();
            }
        }

        setTimeout(() => {
            loadPresentationData();
        }, 100);

        // Polling optimizado para evitar flickering
        let lastPresentationState = null;
        let lastCurrentPresenterId = null;
        let pollingInterval = null;
        
        function startPresentationPolling() {
            if (pollingInterval) return; // Ya est√° corriendo
            
            pollingInterval = setInterval(async () => {
                if (currentTab === 'presentations') {
                    // Solo actualizar estado sin re-renderizar todo
                    await updatePresentationStateOnly();
                }
            }, 3000); // Reducido a 3 segundos para ser menos agresivo
        }
        
        async function updatePresentationStateOnly() {
            try {
                // Solo obtener el estado m√≠nimo necesario
                const sessionStagesResponse = await fetch(`${API_BASE_URL}/sessions/session-stages/?game_session=${currentSessionId}`);
                const sessionStagesData = await sessionStagesResponse.json();
                const sessionStages = Array.isArray(sessionStagesData) ? sessionStagesData : sessionStagesData.results || [];
                const sessionStage = sessionStages.find(s => s.stage_number === 4);
                
                if (!sessionStage) return;
                
                // Solo actualizar si realmente cambi√≥ algo
                const newPresentationState = sessionStage.presentation_state || 'not_started';
                const newCurrentPresenterId = sessionStage.current_presentation_team_id;
                
                if (newPresentationState !== lastPresentationState || 
                    newCurrentPresenterId !== lastCurrentPresenterId) {
                    
                    // Actualizar variables
                    lastPresentationState = newPresentationState;
                    lastCurrentPresenterId = newCurrentPresenterId;
                    presentationState = newPresentationState;
                    currentPresentationTeamId = newCurrentPresenterId;
                    
                    // Obtener equipos solo si es necesario
                    const teamsResponse = await fetch(`${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/teams/`);
                    const teams = await teamsResponse.json();
                    
                    // Actualizar solo el estado visual sin re-renderizar todo
                    await updatePresentationState(teams, sessionStage);
                    
                    // SIEMPRE actualizar progreso de evaluaciones si estamos en estado evaluating
                    // (incluso si el estado principal no cambi√≥, porque las evaluaciones pueden cambiar)
                    if (presentationState === 'evaluating' && currentPresentationTeamId) {
                        await updateEvaluationProgress(teams, currentPresentationTeamId);
                    }
                    
                    // Actualizar contenido de presentaci√≥n si estamos en estado presenting
                    if (presentationState === 'presenting' && currentSessionStageId) {
                        await loadProfessorPresentationContent(currentSessionStageId);
                    }
                }
                
                // SIEMPRE actualizar progreso de evaluaciones si estamos en estado evaluating
                // (incluso si el estado principal no cambi√≥, porque las evaluaciones pueden cambiar)
                if (newPresentationState === 'evaluating' && newCurrentPresenterId) {
                    // Obtener equipos solo para actualizar progreso
                    const teamsResponse = await fetch(`${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/teams/`);
                    if (teamsResponse.ok) {
                        const teams = await teamsResponse.json();
                        await updateEvaluationProgress(teams, newCurrentPresenterId);
                    }
                }
            } catch (error) {
                console.error('Error updating presentation state only:', error);
            }
        }
        
        function stopPresentationPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        async function loadPresentationData() {
            try {
                // Obtener session_stage para Etapa 4
                const sessionStagesResponse = await fetch(`${API_BASE_URL}/sessions/session-stages/?game_session=${currentSessionId}`);
                const sessionStagesData = await sessionStagesResponse.json();
                const sessionStages = Array.isArray(sessionStagesData) ? sessionStagesData : sessionStagesData.results || [];
                
                const sessionStage = sessionStages.find(s => s.stage_number === 4);
                
                if (!sessionStage) {
                    console.warn('‚ö†Ô∏è No se encontr√≥ session_stage para Etapa 4');
                    return;
                }
                
                currentSessionStageId = sessionStage.id;
                presentationOrder = sessionStage.presentation_order || [];
                currentPresentationTeamId = sessionStage.current_presentation_team_id;
                presentationState = sessionStage.presentation_state || 'not_started';

                // Generar orden autom√°ticamente si no existe
                await generateOrderIfNeeded();

                // Cargar equipos
                const teamsResponse = await fetch(`${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/teams/`);
                const teams = await teamsResponse.json();

                // Ocultar tab "Configurar Orden" si las presentaciones ya iniciaron
                const tabConfigBtn = document.getElementById('tabConfig');
                const tabConfigContent = document.getElementById('tabContentConfig');
                if (sessionStage.current_presentation_team_id) {
                    // Presentaciones ya iniciaron - ocultar tab de configuraci√≥n
                    if (tabConfigBtn) tabConfigBtn.style.display = 'none';
                    if (tabConfigContent) tabConfigContent.style.display = 'none';
                    // Forzar cambio a tab de presentaciones si estaba en config
                    if (currentTab === 'config') {
                        switchTab('presentations');
                    }
                } else {
                    // Presentaciones a√∫n no iniciaron - mostrar tab de configuraci√≥n
                    if (tabConfigBtn) tabConfigBtn.style.display = 'block';
                }

                // Renderizar orden de presentaci√≥n (solo en tab de configuraci√≥n)
                if (currentTab === 'config') {
                    renderPresentationOrder(teams, sessionStage);
                }

                // Actualizar estado de presentaciones (solo en tab de presentaciones)
                if (currentTab === 'presentations') {
                    await updatePresentationState(teams, sessionStage);
                    // Iniciar polling solo cuando estamos en tab de presentaciones
                    startPresentationPolling();
                } else {
                    stopPresentationPolling();
                }

                // Cargar evaluaciones (solo actualizar si hay cambios)
                await loadEvaluations(teams);

                // Solo ocultar loading si no est√° ya oculto (evitar flickering)
                const loadingEl = document.getElementById('loading');
                if (loadingEl && loadingEl.classList.contains('show')) {
                    loadingEl.classList.remove('show');
                }
                const teamsGridEl = document.getElementById('teamsGrid');
                if (teamsGridEl && teamsGridEl.style.display !== 'grid') {
                    teamsGridEl.style.display = 'grid';
                }
            } catch (error) {
                console.error('Error loading presentation data:', error);
            }
        }

        function renderPresentationOrder(teams, sessionStage) {
            const orderList = document.getElementById('orderList');
            
            if (!presentationOrder || presentationOrder.length === 0) {
                orderList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Genera un orden de presentaci√≥n para comenzar</p>';
                const startBtn = document.getElementById('startPresentationsBtn');
                const nextBtn = document.getElementById('nextPresentationBtn');
                if (startBtn) startBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
                return;
            }

            orderList.innerHTML = '';
            
            presentationOrder.forEach((teamId, index) => {
                const team = teams.find(t => t.id === teamId);
                if (!team) return;

                const orderItem = document.createElement('div');
                orderItem.className = 'order-item';
                if (currentPresentationTeamId === teamId) {
                    orderItem.classList.add('current');
                }

                orderItem.innerHTML = `
                    <div class="order-number">${index + 1}</div>
                    <div class="team-info">
                        <div class="team-name">${team.name}</div>
                        <div class="team-color">Equipo ${team.color}</div>
                    </div>
                    ${currentPresentationTeamId === teamId ? '<span class="current-badge">üé§ Presentando</span>' : ''}
                    ${!sessionStage.current_presentation_team_id ? `
                        <div class="order-controls">
                            <button class="order-btn up" onclick="moveTeamUp(${index})" ${index === 0 ? 'disabled' : ''} title="Mover arriba">‚ñ≤</button>
                            <button class="order-btn down" onclick="moveTeamDown(${index})" ${index === presentationOrder.length - 1 ? 'disabled' : ''} title="Mover abajo">‚ñº</button>
                        </div>
                    ` : ''}
                `;

                orderList.appendChild(orderItem);
            });

            // Verificar si todos los equipos ya presentaron (as√≠ncrono)
            checkIfAllTeamsPresented(sessionStage).then(allTeamsPresented => {
                // Funci√≥n helper para actualizar display de elementos de forma segura
                function safeSetDisplay(elementId, display) {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.style.display = display;
                    } else {
                        console.warn(`‚ö†Ô∏è [loadPresentationData] Elemento no encontrado: ${elementId}`);
                    }
                }
                
                // Mostrar botones seg√∫n el estado
                if (sessionStage.current_presentation_team_id && !allTeamsPresented) {
                    // Presentaciones iniciadas y a√∫n hay equipos por presentar
                    safeSetDisplay('startPresentationsBtn', 'none');
                    safeSetDisplay('nextPresentationBtn', 'block');
                    safeSetDisplay('startCurrentTeamPitchBtn', 'block'); // Bot√≥n "Listo" para iniciar pitch actual
                    safeSetDisplay('goToResultsBtn', 'none');
                } else if (sessionStage.current_presentation_team_id && allTeamsPresented) {
                    // Todos los equipos ya presentaron
                    safeSetDisplay('startPresentationsBtn', 'none');
                    safeSetDisplay('nextPresentationBtn', 'none');
                    safeSetDisplay('startCurrentTeamPitchBtn', 'none');
                    safeSetDisplay('goToResultsBtn', 'block'); // Bot√≥n para ir a resultados
                } else if (!sessionStage.current_presentation_team_id && allTeamsPresented) {
                    // Todos completaron y no hay equipo actual
                    safeSetDisplay('startPresentationsBtn', 'none');
                    safeSetDisplay('nextPresentationBtn', 'none');
                    safeSetDisplay('startCurrentTeamPitchBtn', 'none');
                    safeSetDisplay('goToResultsBtn', 'block'); // Bot√≥n para ir a resultados
                } else {
                    // Orden generado pero no iniciado
                    safeSetDisplay('startPresentationsBtn', 'block');
                    safeSetDisplay('nextPresentationBtn', 'none');
                    safeSetDisplay('startCurrentTeamPitchBtn', 'none');
                    safeSetDisplay('goToResultsBtn', 'none');
                }
            });
        }

        async function checkIfAllTeamsPresented(sessionStage) {
            if (!sessionStage.presentation_order || sessionStage.presentation_order.length === 0) {
                return false;
            }
            
            // Verificar si todos los equipos completaron su presentaci√≥n
            try {
                const statusResponse = await fetch(`${API_BASE_URL}/sessions/session-stages/${currentSessionStageId}/presentation_status/`);
                if (statusResponse.ok) {
                    const statusData = await statusResponse.json();
                    const completedTeamIds = statusData.completed_team_ids || [];
                    // Si el n√∫mero de equipos completados es igual al n√∫mero total de equipos
                    return completedTeamIds.length === sessionStage.presentation_order.length;
                }
            } catch (error) {
                console.error('Error checking if all teams presented:', error);
            }
            
            // Fallback: verificar si no hay equipo actual y es el √∫ltimo
            if (!sessionStage.current_presentation_team_id) {
                return true; // Si no hay equipo actual, todos ya presentaron
            }
            
            return false;
        }

        async function generateOrderIfNeeded() {
            // Generar orden autom√°ticamente si no existe
            if (!presentationOrder || presentationOrder.length === 0) {
                try {
                    const response = await fetch(`${API_BASE_URL}/sessions/session-stages/${currentSessionStageId}/generate_presentation_order/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        presentationOrder = data.presentation_order || [];
                        console.log('‚úÖ Orden de presentaci√≥n generado autom√°ticamente');
                        // Recargar datos para reflejar el orden generado
                        await loadPresentationData();
                    } else {
                        console.error('Error generando orden autom√°ticamente');
                    }
                } catch (error) {
                    console.error('Error generating order automatically:', error);
                }
            }
        }

        async function moveTeamUp(index) {
            if (index === 0) return;
            
            // Intercambiar con el elemento anterior
            const temp = presentationOrder[index];
            presentationOrder[index] = presentationOrder[index - 1];
            presentationOrder[index - 1] = temp;
            
            await saveOrder();
        }

        async function moveTeamDown(index) {
            if (index === presentationOrder.length - 1) return;
            
            // Intercambiar con el elemento siguiente
            const temp = presentationOrder[index];
            presentationOrder[index] = presentationOrder[index + 1];
            presentationOrder[index + 1] = temp;
            
            await saveOrder();
        }

        async function saveOrder() {
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/session-stages/${currentSessionStageId}/update_presentation_order/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        presentation_order: presentationOrder
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    showAlert('Error: ' + (error.error || 'No se pudo actualizar el orden'), 'error');
                    // Revertir cambios
                    loadPresentationData();
                    return;
                }

                // Recargar para mostrar el nuevo orden
                loadPresentationData();
            } catch (error) {
                console.error('Error saving order:', error);
                showAlert('Error al guardar el orden: ' + error.message, 'error');
                // Revertir cambios
                loadPresentationData();
            }
        }

        async function startPresentations() {
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/session-stages/${currentSessionStageId}/start_presentation/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    showAlert('Error: ' + (error.error || 'No se pudo iniciar las presentaciones'), 'error');
                    return;
                }

                showAlert('‚úÖ Presentaciones iniciadas. Cambiando a la pesta√±a de Presentaciones...', 'success');
                // Cambiar a la pesta√±a de presentaciones
                console.log('üîÑ [startPresentations] Cambiando a tab de presentaciones...');
                switchTab('presentations');
                // loadPresentationData() ya se llama dentro de switchTab('presentations')
            } catch (error) {
                console.error('Error starting presentations:', error);
                showAlert('Error al iniciar presentaciones: ' + error.message, 'error');
            }
        }

        async function startCurrentTeamPitch() {
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/session-stages/${currentSessionStageId}/start_team_pitch/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    showAlert('Error: ' + (error.error || 'No se pudo iniciar el pitch'), 'error');
                    return;
                }

                showAlert('‚úÖ Pitch iniciado. El cron√≥metro comenz√≥.', 'success');
                // Iniciar cron√≥metro
                startProfessorTimer();
                loadPresentationData();
            } catch (error) {
                console.error('Error starting team pitch:', error);
                showAlert('Error al iniciar pitch: ' + error.message, 'error');
            }
        }

        async function finishCurrentPresentation() {
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/session-stages/${currentSessionStageId}/finish_team_presentation/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    showAlert('Error: ' + (error.error || 'No se pudo finalizar la presentaci√≥n'), 'error');
                    return;
                }

                // Detener cron√≥metro
                stopProfessorTimer();
                showAlert('‚úÖ Presentaci√≥n finalizada. Los equipos pueden evaluar ahora.', 'success');
                loadPresentationData();
            } catch (error) {
                console.error('Error finishing presentation:', error);
                showAlert('Error al finalizar presentaci√≥n: ' + error.message, 'error');
            }
        }

        async function startProfessorTimer() {
            // Obtener el temporizador del servidor
            try {
                const timerResponse = await fetch(`${API_BASE_URL}/sessions/session-stages/${currentSessionStageId}/presentation_timer/`);
                if (timerResponse.ok) {
                    const timerData = await timerResponse.json();
                    professorTimerSeconds = timerData.remaining_seconds;
                } else {
                    // Fallback a 180 segundos si no se puede obtener del servidor
                    professorTimerSeconds = 180;
                }
            } catch (error) {
                console.error('Error obteniendo temporizador del servidor:', error);
                professorTimerSeconds = 180; // Fallback
            }
            
            if (professorTimerInterval) {
                clearInterval(professorTimerInterval);
            }
            updateProfessorTimerDisplay();
            professorTimerInterval = setInterval(async () => {
                professorTimerSeconds--;
                updateProfessorTimerDisplay();
                if (professorTimerSeconds <= 0) {
                    stopProfessorTimer();
                }
                // Sincronizar con el servidor cada 5 segundos
                if (professorTimerSeconds % 5 === 0) {
                    try {
                        const timerResponse = await fetch(`${API_BASE_URL}/sessions/session-stages/${currentSessionStageId}/presentation_timer/`);
                        if (timerResponse.ok) {
                            const timerData = await timerResponse.json();
                            const serverRemaining = timerData.remaining_seconds;
                            // Si hay una diferencia significativa (>2 segundos), sincronizar
                            if (Math.abs(professorTimerSeconds - serverRemaining) > 2) {
                                professorTimerSeconds = serverRemaining;
                                updateProfessorTimerDisplay();
                            }
                        }
                    } catch (error) {
                        console.error('Error sincronizando temporizador:', error);
                    }
                }
            }, 1000);
        }

        function stopProfessorTimer() {
            if (professorTimerInterval) {
                clearInterval(professorTimerInterval);
                professorTimerInterval = null;
            }
        }

        function updateProfessorTimerDisplay() {
            const minutes = Math.floor(professorTimerSeconds / 60);
            const seconds = professorTimerSeconds % 60;
            const timerDisplay = document.getElementById('professorTimerDisplay');
            if (timerDisplay) {
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        async function updatePresentationState(teams, sessionStage) {
            // Obtener referencias a los elementos de estado
            const preparingStateEl = document.getElementById('preparingState');
            const presentingStateEl = document.getElementById('presentingState');
            const evaluatingStateEl = document.getElementById('evaluatingState');
            const completedStateEl = document.getElementById('completedState');
            const orderSummaryEl = document.getElementById('presentationOrderSummary');
            
            // Determinar qu√© estado est√° visible actualmente
            const currentVisibleState = preparingStateEl.style.display === 'block' ? 'preparing' :
                                       presentingStateEl.style.display === 'block' ? 'presenting' :
                                       evaluatingStateEl.style.display === 'block' ? 'evaluating' :
                                       completedStateEl.style.display === 'block' ? 'completed' : 'none';

            // Actualizar presentationState desde sessionStage (por si cambi√≥)
            const newPresentationState = sessionStage.presentation_state || 'not_started';
            const newCurrentPresentationTeamId = sessionStage.current_presentation_team_id;
            
            // Verificar si realmente cambi√≥ algo
            const stateChanged = presentationState !== newPresentationState;
            const teamChanged = currentPresentationTeamId !== newCurrentPresentationTeamId;
            
            // Actualizar variables
            presentationState = newPresentationState;
            currentPresentationTeamId = newCurrentPresentationTeamId;

            // Mostrar orden de presentaci√≥n peque√±o (solo si hay orden)
            if (presentationOrder && presentationOrder.length > 0) {
                if (orderSummaryEl.style.display === 'none') {
                    renderPresentationOrderSummary(teams);
                    orderSummaryEl.style.display = 'block';
                }
            }

            // Verificar si todas las presentaciones est√°n completadas
            const allTeamsPresented = await checkIfAllTeamsPresented(sessionStage);
            
            if (allTeamsPresented && !currentPresentationTeamId) {
                // Todas las presentaciones completadas
                if (currentVisibleState !== 'completed') {
                    preparingStateEl.style.display = 'none';
                    presentingStateEl.style.display = 'none';
                    evaluatingStateEl.style.display = 'none';
                    completedStateEl.style.display = 'block';
                }
                return;
            }

            // Determinar el estado objetivo
            let targetState = 'none';
            let targetTeam = null;
            
            if (presentationState === 'preparing' && currentPresentationTeamId) {
                targetState = 'preparing';
                targetTeam = teams.find(t => t.id === currentPresentationTeamId);
            } else if (presentationState === 'presenting' && currentPresentationTeamId) {
                targetState = 'presenting';
                targetTeam = teams.find(t => t.id === currentPresentationTeamId);
            } else if (presentationState === 'evaluating' && currentPresentationTeamId) {
                targetState = 'evaluating';
                targetTeam = teams.find(t => t.id === currentPresentationTeamId);
            }

            // Solo actualizar DOM si realmente cambi√≥ el estado visible o el equipo
            if (currentVisibleState !== targetState || stateChanged || teamChanged) {
                // Ocultar todos los estados
                preparingStateEl.style.display = 'none';
                presentingStateEl.style.display = 'none';
                evaluatingStateEl.style.display = 'none';
                completedStateEl.style.display = 'none';
                
                // Mostrar el estado correcto
                if (targetState === 'preparing' && targetTeam) {
                    document.getElementById('preparingTeamName').textContent = `Iniciar Pitch del Equipo ${targetTeam.name}`;
                    document.getElementById('startPitchTeamName').textContent = targetTeam.name;
                    preparingStateEl.style.display = 'block';
                    console.log('‚úÖ Mostrando estado de preparaci√≥n para:', targetTeam.name);
                } else if (targetState === 'presenting' && targetTeam) {
                    document.getElementById('presentingTeamName').textContent = `${targetTeam.name} est√° presentando`;
                    document.getElementById('finishPitchTeamName').textContent = targetTeam.name;
                    presentingStateEl.style.display = 'block';
                    
                    // Cargar y mostrar prototipo y pitch
                    await loadProfessorPresentationContent(currentSessionStageId);
                    
                    // Asegurar que el cron√≥metro est√© corriendo
                    if (!professorTimerInterval) {
                        await startProfessorTimer();
                    }
                } else if (targetState === 'evaluating' && targetTeam) {
                    document.getElementById('evaluatingTeamName').textContent = targetTeam.name;
                    evaluatingStateEl.style.display = 'block';
                    // Actualizar progreso de evaluaciones
                    await updateEvaluationProgress(teams, currentPresentationTeamId);
                }
            } else if (targetTeam) {
                // Solo actualizar textos si el estado no cambi√≥ pero el equipo podr√≠a haber cambiado
                if (targetState === 'preparing' && targetTeam) {
                    const preparingTeamNameEl = document.getElementById('preparingTeamName');
                    const expectedText = `Iniciar Pitch del Equipo ${targetTeam.name}`;
                    if (preparingTeamNameEl && preparingTeamNameEl.textContent !== expectedText) {
                        preparingTeamNameEl.textContent = expectedText;
                        document.getElementById('startPitchTeamName').textContent = targetTeam.name;
                    }
                } else if (targetState === 'presenting' && targetTeam) {
                    const presentingTeamNameEl = document.getElementById('presentingTeamName');
                    const expectedText = `${targetTeam.name} est√° presentando`;
                    if (presentingTeamNameEl && presentingTeamNameEl.textContent !== expectedText) {
                        presentingTeamNameEl.textContent = expectedText;
                        document.getElementById('finishPitchTeamName').textContent = targetTeam.name;
                    }
                    // Actualizar contenido de presentaci√≥n
                    if (currentSessionStageId) {
                        await loadProfessorPresentationContent(currentSessionStageId);
                    }
                } else if (targetState === 'evaluating' && targetTeam) {
                    const evaluatingTeamNameEl = document.getElementById('evaluatingTeamName');
                    if (evaluatingTeamNameEl && evaluatingTeamNameEl.textContent !== targetTeam.name) {
                        evaluatingTeamNameEl.textContent = targetTeam.name;
                        // Actualizar progreso de evaluaciones
                        await updateEvaluationProgress(teams, currentPresentationTeamId);
                    }
                }
            }
        }

        async function loadProfessorPresentationContent(sessionStageId) {
            try {
                const presentationStatusResponse = await fetch(`${API_BASE_URL}/sessions/session-stages/${sessionStageId}/presentation_status/`);
                if (presentationStatusResponse.ok) {
                    const presentationStatus = await presentationStatusResponse.json();
                    const prototypeUrl = presentationStatus.current_team_prototype || null;
                    const pitchData = presentationStatus.current_team_pitch || null;
                    
                    const prototypeContainer = document.getElementById('professorPrototypeContainer');
                    const pitchContainer = document.getElementById('professorPitchContainer');
                    
                    // Mostrar prototipo
                    if (prototypeUrl && prototypeContainer) {
                        prototypeContainer.innerHTML = `<img src="${prototypeUrl}" alt="Prototipo" style="width: 100%; max-width: 400px; height: auto; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); margin: 0 auto; display: block;" onerror="this.parentElement.innerHTML='<p style=\\'color: #999; text-align: center; padding: 20px; font-style: italic;\\'>Error al cargar la imagen</p>'">`;
                    } else if (prototypeContainer) {
                        prototypeContainer.innerHTML = '<p style="color: #999; text-align: center; padding: 20px; font-style: italic;">No hay prototipo disponible</p>';
                    }
                    
                    // Mostrar pitch
                    if (pitchData && pitchContainer) {
                        let pitchHTML = '';
                        if (pitchData.intro_problem) {
                            pitchHTML += `
                                <div style="margin-bottom: 20px;">
                                    <h5 style="color: #667eea; font-size: 16px; font-weight: 600; margin-bottom: 8px;">üîç Problema</h5>
                                    <p style="color: #555; font-size: 14px; white-space: pre-wrap; line-height: 1.6;">${pitchData.intro_problem}</p>
                                </div>
                            `;
                        }
                        if (pitchData.solution) {
                            pitchHTML += `
                                <div style="margin-bottom: 20px;">
                                    <h5 style="color: #667eea; font-size: 16px; font-weight: 600; margin-bottom: 8px;">üí° Soluci√≥n</h5>
                                    <p style="color: #555; font-size: 14px; white-space: pre-wrap; line-height: 1.6;">${pitchData.solution}</p>
                                </div>
                            `;
                        }
                        if (pitchData.closing) {
                            pitchHTML += `
                                <div style="margin-bottom: 20px;">
                                    <h5 style="color: #667eea; font-size: 16px; font-weight: 600; margin-bottom: 8px;">üéØ Cierre</h5>
                                    <p style="color: #555; font-size: 14px; white-space: pre-wrap; line-height: 1.6;">${pitchData.closing}</p>
                                </div>
                            `;
                        }
                        
                        if (pitchHTML) {
                            pitchContainer.innerHTML = pitchHTML;
                        } else {
                            pitchContainer.innerHTML = '<p style="color: #999; text-align: center; padding: 20px; font-style: italic;">No hay guion disponible</p>';
                        }
                    } else if (pitchContainer) {
                        pitchContainer.innerHTML = '<p style="color: #999; text-align: center; padding: 20px; font-style: italic;">No hay guion disponible</p>';
                    }
                }
            } catch (error) {
                console.error('Error cargando contenido de presentaci√≥n:', error);
            }
        }

        function renderPresentationOrderSummary(teams) {
            const summaryList = document.getElementById('presentationOrderSummaryList');
            summaryList.innerHTML = '';
            
            presentationOrder.forEach((teamId, index) => {
                const team = teams.find(t => t.id === teamId);
                if (team) {
                    const badge = document.createElement('span');
                    badge.style.cssText = `
                        background: ${teamId === currentPresentationTeamId ? '#28a745' : '#667eea'};
                        color: white;
                        padding: 5px 12px;
                        border-radius: 15px;
                        font-size: 12px;
                        font-weight: 600;
                    `;
                    badge.textContent = `${index + 1}. ${team.name}`;
                    summaryList.appendChild(badge);
                }
            });
        }

        async function updateEvaluationProgress(teams, evaluatedTeamId) {
            try {
                // Obtener todas las evaluaciones para el equipo actual
                const evaluationsResponse = await fetch(`${API_BASE_URL}/sessions/peer-evaluations/?evaluated_team=${evaluatedTeamId}&game_session=${currentSessionId}`);
                const evaluationsData = await evaluationsResponse.json();
                const evaluations = Array.isArray(evaluationsData) ? evaluationsData : evaluationsData.results || [];
                
                const totalTeams = teams.length;
                const expectedEvaluations = totalTeams - 1; // Todos menos el que present√≥
                const evaluatedBy = evaluations.length;
                const progress = (evaluatedBy / expectedEvaluations) * 100;

                // Actualizar barra de progreso
                document.getElementById('evaluationProgressBar').style.width = `${progress}%`;
                document.getElementById('evaluationProgressText').textContent = 
                    `${evaluatedBy} de ${expectedEvaluations} equipos han evaluado`;

                // Mostrar lista de equipos que han evaluado
                const progressDiv = document.getElementById('evaluationProgress');
                const evaluatorIds = evaluations.map(e => e.evaluator_team);
                const evaluatorNames = teams
                    .filter(t => evaluatorIds.includes(t.id))
                    .map(t => t.name);
                
                progressDiv.innerHTML = evaluatorNames.length > 0 
                    ? `<p style="color: #666;">Equipos que han evaluado: ${evaluatorNames.join(', ')}</p>`
                    : '<p style="color: #666;">Ning√∫n equipo ha evaluado a√∫n</p>';

                // Verificar si todos los equipos ya presentaron y si este es el √∫ltimo equipo
                const sessionStagesResponse = await fetch(`${API_BASE_URL}/sessions/session-stages/?game_session=${currentSessionId}`);
                const sessionStagesData = await sessionStagesResponse.json();
                const sessionStages = Array.isArray(sessionStagesData) ? sessionStagesData : sessionStagesData.results || [];
                const sessionStage = sessionStages.find(s => s.stage_number === 4);
                
                let isLastTeam = false;
                if (sessionStage && sessionStage.presentation_order && evaluatedTeamId) {
                    const presentationOrder = sessionStage.presentation_order || [];
                    // Verificar si este es el √∫ltimo equipo en el orden de presentaci√≥n
                    const lastTeamId = presentationOrder[presentationOrder.length - 1];
                    isLastTeam = (evaluatedTeamId === lastTeamId);
                }

                // Mostrar/ocultar botones seg√∫n el estado
                const nextBtn = document.getElementById('nextPresentationBtn');
                const finalResultsBtn = document.getElementById('goToFinalResultsBtn');
                const waitingText = document.getElementById('waitingEvaluationsText');
                
                if (evaluatedBy >= expectedEvaluations) {
                    // Todas las evaluaciones completadas para este equipo
                    if (isLastTeam) {
                        // Es el √∫ltimo equipo y todos lo evaluaron - mostrar bot√≥n de resultados finales
                        if (nextBtn) nextBtn.style.display = 'none';
                        if (finalResultsBtn) finalResultsBtn.style.display = 'block';
                        if (waitingText) waitingText.style.display = 'none';
                    } else {
                        // No es el √∫ltimo equipo - mostrar bot√≥n siguiente turno
                        if (nextBtn) nextBtn.style.display = 'block';
                        if (finalResultsBtn) finalResultsBtn.style.display = 'none';
                        if (waitingText) waitingText.style.display = 'none';
                    }
                } else {
                    // A√∫n faltan evaluaciones
                    if (nextBtn) nextBtn.style.display = 'none';
                    if (finalResultsBtn) finalResultsBtn.style.display = 'none';
                    if (waitingText) waitingText.style.display = 'block';
                }
            } catch (error) {
                console.error('Error updating evaluation progress:', error);
            }
        }
        
        async function goToFinalResults() {
            try {
                // Verificar que todos hayan evaluado antes de ir a resultados
                const allEvaluated = await checkAllEvaluated();
                if (!allEvaluated) {
                    showAlert('‚ö†Ô∏è Espera a que todos los equipos completen su evaluaci√≥n antes de ir a resultados', 'error');
                    return;
                }

                // Confirmar acci√≥n
                if (!confirm('¬øEst√°s seguro de que quieres ir a los resultados finales? Todas las presentaciones y evaluaciones han sido completadas.')) {
                    return;
                }

                // Completar la etapa 4
                // No necesitamos enviar stage_id - el endpoint lo obtiene autom√°ticamente de current_stage
                const authToken = localStorage.getItem('authToken');
                
                // Usar FormData porque el endpoint usa MultiPartParser/FormParser
                const formData = new FormData();
                // No enviar stage_id - el endpoint usa game_session.current_stage autom√°ticamente
                
                const headers = {
                    'X-CSRFToken': getCookie('csrftoken')
                };
                
                // Agregar token de autenticaci√≥n si est√° disponible
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(`${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/complete_stage/`, {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });

                if (!response.ok) {
                    let errorMessage = 'No se pudo completar la etapa';
                    let errorDetails = null;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorData.detail || errorMessage;
                        errorDetails = errorData;
                    } catch (e) {
                        errorMessage = `Error HTTP ${response.status}: ${response.statusText}`;
                    }
                    console.error('Error en complete_stage:', {
                        status: response.status,
                        statusText: response.statusText,
                        errorDetails: errorDetails,
                        requestData: { stage_id: 4 }
                    });
                    showAlert('Error: ' + errorMessage, 'error');
                    return;
                }

                showAlert('‚úÖ Redirigiendo a resultados finales...', 'success');
                
                // Redirigir a resultados de la etapa 4
                setTimeout(() => {
                    window.location.href = `/profesor/resultados/${currentSessionId}/?stage_id=4`;
                }, 1000);
            } catch (error) {
                console.error('Error going to final results:', error);
                showAlert('Error al ir a resultados finales: ' + error.message, 'error');
            }
        }

        async function goToResults() {
            console.log('üéØ [Profesor goToResults] INICIANDO - Completando Etapa 4...');
            console.log('   - Session ID:', currentSessionId);
            console.log('   - Timestamp:', new Date().toISOString());
            
            try {
                // IMPORTANTE: Completar la etapa en el backend para que las tablets sepan que deben ir a reflexi√≥n
                // Esto limpia current_activity y marca la etapa como completada
                console.log('üì° [Profesor goToResults] Llamando a complete_stage endpoint...');
                const response = await fetch(`${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/complete_stage/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        stage_number: 4
                    })
                });
                
                console.log('üì• [Profesor goToResults] Respuesta del servidor:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ [Profesor goToResults] Etapa 4 completada en el backend:', {
                        stage_completed: data.stage_completed,
                        stage_id: data.stage_id,
                        stage_name: data.stage_name,
                        stage_number: data.stage_number,
                        current_activity: data.current_activity,
                        current_activity_name: data.current_activity_name,
                        message: data.message
                    });
                    console.log('   - current_activity ahora es:', data.current_activity);
                    console.log('   - Las tablets deber√≠an detectar esto en el pr√≥ximo polling');
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Error desconocido' }));
                    console.warn('‚ö†Ô∏è [Profesor goToResults] No se pudo completar la etapa en el backend:', errorData);
                    console.warn('   - Continuando de todas formas...');
                }
            } catch (error) {
                console.error('‚ùå [Profesor goToResults] Error al completar etapa:', error);
                console.error('   - Stack:', error.stack);
                console.error('   - Continuando de todas formas para que el profesor pueda ver resultados');
            }
            
            console.log('üîÑ [Profesor goToResults] Redirigiendo a resultados...');
            // Redirigir a resultados de la etapa 4 (no directamente a reflexi√≥n)
            window.location.href = `/profesor/resultados/${currentSessionId}/?stage_id=4`;
        }

        async function nextPresentation() {
            try {
                // Verificar que todos hayan evaluado antes de avanzar
                const allEvaluated = await checkAllEvaluated();
                if (!allEvaluated) {
                    showAlert('‚ö†Ô∏è Espera a que todos los equipos completen su evaluaci√≥n antes de avanzar', 'error');
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/sessions/session-stages/${currentSessionStageId}/next_presentation/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    showAlert('Error: ' + (error.error || 'No se pudo avanzar'), 'error');
                    return;
                }

                const data = await response.json();
                
                if (!data.current_presentation_team_id) {
                    showAlert('‚úÖ Todas las presentaciones han sido completadas', 'success');
                    // Recargar datos para que se actualice el estado y muestre el bot√≥n de resultados finales
                    loadPresentationData();
                } else {
                    showAlert('‚úÖ Turno avanzado al siguiente equipo', 'success');
                    loadPresentationData();
                }
            } catch (error) {
                console.error('Error advancing presentation:', error);
                showAlert('Error al avanzar turno: ' + error.message, 'error');
            }
        }

        async function checkAllEvaluated() {
            if (!currentPresentationTeamId) return true;
            
            try {
                const teamsResponse = await fetch(`${API_BASE_URL}/sessions/game-sessions/${currentSessionId}/teams/`);
                const teams = await teamsResponse.json();
                
                // Obtener todas las evaluaciones para el equipo actual
                const evaluationsResponse = await fetch(`${API_BASE_URL}/sessions/peer-evaluations/?evaluated_team=${currentPresentationTeamId}&game_session=${currentSessionId}`);
                const evaluationsData = await evaluationsResponse.json();
                const evaluations = Array.isArray(evaluationsData) ? evaluationsData : evaluationsData.results || [];
                
                // Contar cu√°ntos equipos han evaluado (excluyendo el equipo que present√≥)
                const evaluatorTeamIds = evaluations.map(e => e.evaluator_team);
                const totalTeams = teams.length;
                const evaluatedBy = evaluatorTeamIds.length;
                const expectedEvaluations = totalTeams - 1; // Todos menos el que present√≥
                
                return evaluatedBy >= expectedEvaluations;
            } catch (error) {
                console.error('Error checking evaluations:', error);
                return false;
            }
        }

        let lastEvaluationsHash = null;
        
        async function loadEvaluations(teams, forceUpdate = false) {
            try {
                const evaluationsResponse = await fetch(`${API_BASE_URL}/sessions/peer-evaluations/?game_session=${currentSessionId}`);
                const evaluationsData = await evaluationsResponse.json();
                const evaluations = Array.isArray(evaluationsData) ? evaluationsData : evaluationsData.results || [];

                // Crear hash simple de las evaluaciones para detectar cambios
                const evaluationsHash = JSON.stringify(evaluations.map(e => ({
                    id: e.id,
                    evaluator: e.evaluator_team,
                    evaluated: e.evaluated_team,
                    score: e.total_score
                })));
                
                // Solo renderizar si hay cambios o si se fuerza actualizaci√≥n
                if (forceUpdate || evaluationsHash !== lastEvaluationsHash) {
                    lastEvaluationsHash = evaluationsHash;
                    renderTeams(teams, evaluations);
                }
            } catch (error) {
                console.error('Error loading evaluations:', error);
                if (forceUpdate) {
                    renderTeams(teams, []);
                }
            }
        }

        function renderTeams(teams, evaluations) {
            const teamsGrid = document.getElementById('teamsGrid');
            teamsGrid.innerHTML = '';

            teams.forEach(team => {
                const teamEvaluations = evaluations.filter(e => e.evaluated_team === team.id);
                const isPresenting = currentPresentationTeamId === team.id;

                const teamCard = document.createElement('div');
                teamCard.className = 'team-card';
                if (isPresenting) {
                    teamCard.classList.add('presenting');
                }

                const totalScore = teamEvaluations.reduce((sum, e) => sum + (e.total_score || 0), 0);
                const avgScore = teamEvaluations.length > 0 ? Math.round(totalScore / teamEvaluations.length) : 0;

                teamCard.innerHTML = `
                    <div class="team-header">
                        <div class="team-color-circle" style="background: ${getTeamColorHex(team.color)};">
                            ${team.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="team-name">${team.name}</div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Tokens:</strong> ${team.tokens_total || 0}
                    </div>
                    ${teamEvaluations.length > 0 ? `
                        <div style="margin-bottom: 10px;">
                            <strong>Evaluaciones recibidas:</strong> ${teamEvaluations.length}<br>
                            <strong>Puntuaci√≥n promedio:</strong> ${avgScore} puntos
                        </div>
                        <div class="evaluations-list">
                            <strong>Evaluaciones:</strong>
                            ${teamEvaluations.map(eval => `
                                <div class="evaluation-item">
                                    <div class="evaluation-header">
                                        <span>De: ${eval.evaluator_team_name || 'Equipo'}</span>
                                        <span class="evaluation-score">${eval.total_score} puntos</span>
                                    </div>
                                    ${eval.feedback ? `<div style="margin-top: 5px; color: #666; font-size: 14px;">${eval.feedback}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: #999; font-size: 14px;">A√∫n no ha recibido evaluaciones</p>'}
                `;

                teamsGrid.appendChild(teamCard);
            });
        }

        function getTeamColorHex(color) {
            const colorMap = {
                'Verde': '#28a745',
                'Azul': '#007bff',
                'Rojo': '#dc3545',
                'Amarillo': '#ffc107',
                'Naranja': '#fd7e14',
                'Morado': '#6f42c1',
                'Rosa': '#e83e8c',
                'Cian': '#17a2b8',
                'Gris': '#6c757d',
                'Marr√≥n': '#795548'
            };
            return colorMap[color] || '#667eea';
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Animaci√≥n de spinner
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>

